{%- liquid
  assign section_blocks = section.blocks
  assign se_stts = section.settings
  assign ccount = cart.item_count
  assign ck_lumise = 'ck_lumise'
  assign cart_url = routes.cart_url
  assign cart_change_url = routes.cart_change_url
  assign min_qty = settings.min_qty | plus: 0
  assign compare_tt_price = 0
  assign shipping_amount = settings.free_ship_pr.metafields.theme.shipping_money.value | default: settings.free_ship_pr.price | default: -1
  assign total_price = cart.total_price

  assign se_style = se_stts.style
  assign se_pos = se_stts.pos

  assign gift_pr = all_products[settings.gift_wrap_pr]
  assign gift_pr_id = gift_pr.id
  assign arr_gift_id = cart.items | where: 'product_id', gift_pr_id
  if cart.note != blank
    assign style_add = 't4s-d-none'
    assign style_edit = ''
  else
    assign style_add = ''
    assign style_edit = 't4s-d-none'
  endif
  assign edit_item = settings.edit_item
  assign atc_ajax_enable = settings.atc_ajax_enable
  assign cart_ajax_enable = settings.cart_ajax_enable
-%}

<svg class="t4s-d-none">
  <symbol id="icon-cart-remove" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>
  </symbol>
  <symbol id="icon-cart-edit" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
  </symbol>
  <symbol id="icon-cart-tag" viewBox="0 0 448 512">
    <path d="M48 32H197.5C214.5 32 230.7 38.74 242.7 50.75L418.7 226.7C443.7 251.7 443.7 292.3 418.7 317.3L285.3 450.7C260.3 475.7 219.7 475.7 194.7 450.7L18.75 274.7C6.743 262.7 0 246.5 0 229.5V80C0 53.49 21.49 32 48 32L48 32zM112 176C129.7 176 144 161.7 144 144C144 126.3 129.7 112 112 112C94.33 112 80 126.3 80 144C80 161.7 94.33 176 112 176z"/>
  </symbol>
  <symbol id="icon-cart-spinner" viewBox="0 0 66 66">
    <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
  </symbol>
  <symbol id="icon-cart-check" viewBox="0 0 448 512">
    <path d="M443.3 100.7C449.6 106.9 449.6 117.1 443.3 123.3L171.3 395.3C165.1 401.6 154.9 401.6 148.7 395.3L4.686 251.3C-1.562 245.1-1.562 234.9 4.686 228.7C10.93 222.4 21.06 222.4 27.31 228.7L160 361.4L420.7 100.7C426.9 94.44 437.1 94.44 443.3 100.7H443.3z"/>
  </symbol>
  <symbol id="icon-cart-selected" viewBox="0 0 24 24">
  <path d="M9 20l-7-7 3-3 4 4L19 4l3 3z"></path>
  </symbol>
</svg>

{%- capture html_tabs -%}
  {%- liquid
    assign isFirst = false
    assign tabs_list = se_stts.tabs_list | default: "cart"
    unless tabs_list contains 'cart'
      assign isFirst = true
    endunless
    assign tabs_list = tabs_list | remove: ' '

    if se_stts.product_list == blank
      assign tabs_list = tabs_list | remove: 'best_seller,' | remove: 'best_seller'
    endif 
    if settings.wishlist_mode == "3"
      assign tabs_list = tabs_list | remove: 'wishlist,' | remove: 'wishlist'
    endif
    assign tabs_list = tabs_list | split: ',' | uniq
  -%}
{%- liquid
  assign section_blocks = section.blocks
  assign se_stts = section.settings
  assign ccount = cart.item_count
  assign ck_lumise = 'ck_lumise'
  assign cart_url = routes.cart_url
  assign cart_change_url = routes.cart_change_url
  assign min_qty = settings.min_qty | plus: 0
  assign compare_tt_price = 0
  assign shipping_amount = settings.free_ship_pr.metafields.theme.shipping_money.value | default: settings.free_ship_pr.price | default: -1
  assign total_price = cart.total_price

  assign se_style = se_stts.style
  assign se_pos = se_stts.pos

  assign gift_pr = all_products[settings.gift_wrap_pr]
  assign gift_pr_id = gift_pr.id
  assign arr_gift_id = cart.items | where: 'product_id', gift_pr_id
  if cart.note != blank
    assign style_add = 't4s-d-none'
    assign style_edit = ''
  else
    assign style_add = ''
    assign style_edit = 't4s-d-none'
  endif
  assign edit_item = settings.edit_item
  assign atc_ajax_enable = settings.atc_ajax_enable
  
  assign announcement_bg_color = se_stts.announcement_bg_color | default: '#004622'
  assign announcement_text_color = se_stts.announcement_text_color | default: '#ffffff'
  assign announcement_rich_text = se_stts.announcement_rich_text
  
  assign announcement_padding_top_mobile = se_stts.announcement_padding_top_mobile | default: 12
  assign announcement_padding_bottom_mobile = se_stts.announcement_padding_bottom_mobile | default: 12
  assign announcement_padding_top_desktop = se_stts.announcement_padding_top_desktop | default: 16
  assign announcement_padding_bottom_desktop = se_stts.announcement_padding_bottom_desktop | default: 16
  
  assign announcement_margin_top = se_stts.announcement_margin_top | default: 0
  assign announcement_margin_bottom = se_stts.announcement_margin_bottom | default: 0
  
  assign announcement_font_size_mobile = se_stts.announcement_font_size_mobile | default: 14
  assign announcement_font_size_desktop = se_stts.announcement_font_size_desktop | default: 16
-%}

{% if announcement_rich_text != blank and announcement_rich_text != empty %}
  <div 
    class="cart-announcement-bar w-full text-center"
    style="
      background-color: {{ announcement_bg_color }};
      color: {{ announcement_text_color }};
      padding-top: {{ announcement_padding_top_mobile }}px;
      padding-bottom: {{ announcement_padding_bottom_mobile }}px;
      margin-top: {{ announcement_margin_top }}px;
      margin-bottom: {{ announcement_margin_bottom }}px;
      font-size: {{ announcement_font_size_mobile }}px;
    "
  >
    <div class="max-w-7xl mx-auto px-4">
      <div class="rte" style="color: {{ announcement_text_color }};">
        {{ announcement_rich_text }}
      </div>
    </div>
  </div>

  <style>
    @media (min-width: 1024px) {
      .cart-announcement-bar {
        padding-top: {{ announcement_padding_top_desktop }}px !important;
        padding-bottom: {{ announcement_padding_bottom_desktop }}px !important;
        font-size: {{ announcement_font_size_desktop }}px !important;
      }
    }
    
    .cart-announcement-bar .rte p {
      margin: 0;
      line-height: 1.5;
    }
    
    .cart-announcement-bar .rte a {
      color: inherit;
      text-decoration: underline;
    }
    
    .cart-announcement-bar .rte strong {
      font-weight: 700;
    }
  </style>
{% endif %}

{%- comment -%} RESTO DE TU SECCIÓN DE CARRITO {%- endcomment -%}


  {%- if tabs_list.size > 0 -%}
    <div class="t4s-drawer__tabs-list t4s-minicart-tabs-list{% if tabs_list.size == 1 %} t4s-d-none{% endif %}" data-tab-cart-wrap>
      {%- for tabs_item in tabs_list limit: 4 -%}
        {%- if forloop.first and isFirst -%}{% assign classs_active = 'is--active' %}{% assign title_active = 'cart.mini_cart.title_' | append: tabs_item %}{% else %}{% assign classs_active = '' %}{% endif -%}
        {%- if tabs_item == "best_seller" -%}
          <button type="button" data-tab-cart-item class="t4s-drawer__tabs-item t4s-minicart-tabs-item {{ classs_active }}" data-title="{{ 'cart.mini_cart.title_best_seller' | t | escape }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
          </button>
        {%- elsif tabs_item == "wishlist" -%}
          <button type="button" data-tab-cart-item class="t4s-drawer__tabs-item t4s-minicart-tabs-item {{ classs_active }}" data-title="{{ 'cart.mini_cart.title_wishlist' | t | escape }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-heart"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
          </button>
        {%- elsif tabs_item == "visited" -%}
          <button type="button" data-tab-cart-item class="t4s-drawer__tabs-item t4s-minicart-tabs-item {{ classs_active }}" data-title="{{ 'cart.mini_cart.title_visited' | t | escape }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        {%- elsif tabs_item == "cart" -%}
          <button type="button" data-is-tab-cart data-tab-cart-item class="t4s-drawer__tabs-item t4s-minicart-tabs-item is--active" data-title="{{ 'cart.mini_cart.title' | t | escape }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-bag"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
          </button>
      {%- endif -%}
      {%- endfor -%}
    </div>
  {%- endif -%}
{%- endcapture -%}

{%- capture html_btn -%}
  {% if se_stts.enable_note or se_stts.enable_gift_wrap or se_stts.enable_rates or se_stts.enable_discount %}
    {%- if se_style == '1' -%}
      <div data-cart-tools class="t4s-mini_cart__tool t4s-when-cart-emty t4s-text-center">
        {%- if se_stts.enable_note -%}
         <div data-tooltip="top" data-cart-tool_action data-id="note" class="mini_cart_tool_btn is--note is--addNote {{ style_add }}">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clipboard"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>{{ 'cart.tool.note' | t }}
         </div>
         <div data-tooltip="top" data-cart-tool_action data-id="note" class="mini_cart_tool_btn is--note is--editNote {{ style_edit }}">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clipboard"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>{{ 'cart.tool.edit_note' | t }}
        </div>
        {%- endif -%}
        {%- if se_stts.enable_gift_wrap and gift_pr.available == true -%}<div data-tooltip="top" data-toogle-gift data-cart-tool_action data-id="gift" class="mini_cart_tool_btn is--gift"{% if arr_gift_id.size > 0 %} style=" display: none"{% endif %}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-gift"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>{{ 'cart.tool.add_gift_wrap' | t }}</div>{%- endif -%}
        {%- if se_stts.enable_rates -%}<div data-tooltip="top" data-cart-tool_action data-id="rates" class="mini_cart_tool_btn is--rates"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-truck"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>{{ 'cart.shipping_estimator.title' | t }}</div>{%- endif -%}
        {%- if se_stts.enable_discount -%}<div data-tooltip="top" data-cart-tool_action data-id="discount" class="mini_cart_tool_btn is--discount"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-percent"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg>{{ 'cart.tool.add_coupon' | t }}</div>{%- endif -%}
      </div>
    {%- else -%}
      <div data-cart-tools class="t4s-mini_cart__tool t4s-mini_cart__tool-style-btn t4s-when-cart-emty">
        {%- if se_stts.enable_note -%}
        <div data-cart-tool_action data-id="note" class="mini_cart_tool_btn is--note is--addNote t4s-pr t4s-truncate {{ style_add }}">{{ 'cart.tool.note' | t }}</div>
        <div data-cart-tool_action data-id="note" class="mini_cart_tool_btn is--note is--editNote t4s-pr t4s-truncate {{ style_edit }}">{{ 'cart.tool.edit_note' | t }}</div>
        {%- endif -%}
        {%- if se_stts.enable_gift_wrap and gift_pr.available == true -%}<div data-toogle-gift data-cart-tool_action data-id="gift" class="mini_cart_tool_btn is--gift t4s-pr t4s-truncate"{% if arr_gift_id.size > 0 %} style=" display: none"{% endif %}>{{ 'cart.tool.add_gift_wrap' | t }}</div>{%- endif -%}
        {%- if se_stts.enable_rates -%}<div data-cart-tool_action data-id="rates" class="mini_cart_tool_btn is--rates t4s-pr t4s-truncate">{{ 'cart.shipping_estimator.title' | t }}</div>{%- endif -%}
        {%- if se_stts.enable_discount -%}<div data-cart-tool_action data-id="discount" class="mini_cart_tool_btn is--discount t4s-pr t4s-truncate">{{ 'cart.tool.add_coupon' | t }}</div>{%- endif -%}
      </div>
    {%- endif -%}
  {%- endif -%}
{%- endcapture -%}

{%- if request.design_mode -%}
  <link href="{{ 'mini-cart.css' | asset_url }}" rel="stylesheet" media="print" onload="this.media='all'">
  <div
    data-cart-wrapper
    id="t4s-mini_cart"
    data-ccount="{{ cart.item_count }}"
    class="t4s-drawer t4s-drawer__right t4s-dn"
    aria-hidden="true"
  >
{%- endif -%}

<div class="t4s-drawer__header">
  <p data-cart-tab-title class="font-['Barlow',Helvetica] font-bold text-[#004623] text-[16px]">
    {%- if title_active != blank -%}
      {{- title_active | t | escape -}}
    {%- else -%}
      {{- 'cart.mini_cart.title' | t | escape -}}
    {%- endif -%}
  </p>
  <button class="" data-drawer-close aria-label="{{ 'cart.mini_cart.close_cart' | t }}">
    <svg
      class="t4s-iconsvg-close"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="feather feather-x"
    >
      <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>
</div>

{{ html_tabs }}

{%- if tabs_list.size > 0 %}
  {%- for tabs_item in tabs_list limit: 4 -%}
    {%- if forloop.first and isFirst -%}
      {% assign aria_hidden = false -%}
    {%- else -%}
      {%- assign aria_hidden = true -%}
    {%- endif -%}
    {%- if tabs_item == 'best_seller' -%}
      {%- liquid
        assign product_list = se_stts.product_list
        assign price_varies_style = settings.price_varies_style
        assign placeholder_img = settings.placeholder_img
      -%}
      <div
        id="t4s-tab-bestseller"
        data-cart-tab-content
        class="t4s-minicart-tabs-item-wrap"
        aria-hidden="{{ aria_hidden }}"
      >
        <div
          class="t4s-minicart-tabs-item-content t4s-current-scrollbar t4s-list-products-bestseller t4s_cover t4s_position_8 t4s_ratioadapt"
          data-t4s-scroll-me
        >
          {% for product in product_list %}
            {%- render 'pr-loop-item',
              block: block,
              product: product,
              placeholder_img: placeholder_img,
              price_varies_style: price_varies_style
            -%}
          {% endfor %}
        </div>
      </div>
    {%- elsif tabs_item == 'wishlist' -%}
      <div
        id="t4s-tab-wishlist"
        data-cart-tab-content
        class="t4s-minicart-tabs-item-wrap"
        aria-hidden="{{ aria_hidden }}"
      >
        <div
          class="t4s-minicart-tabs-item-content t4s-current-scrollbar t4s-list-products-wishlist t4s_cover t4s_position_8 t4s_ratioadapt"
          data-t4s-scroll-me
        >
          <div class="t4s-mini_cart__emty t4s-text-center t4s-tab-wishlist-empty">
            <svg
              class="t4s-empty-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="feather feather-heart"
            >
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            {{ 'cart.mini_cart.empty_wishlist' | t }}
          </div>
          <div class="t4s-tab-wishlist-skeleton" style="display: none;">
            {%- for i in (1..5) -%}
              <div class="t4s-row t4s-space-item-inner t4s-widget__pr">
                <div class="t4s-col-item t4s-col t4s-widget_img_pr"><div class="t4s-skeleton_img"></div></div>
                <div class="t4s-col-item t4s-col t4s-widget_if_pr t4s-pr">
                  <div class="t4s-skeleton_txt1"></div>
                  <div class="t4s-skeleton_txt2"></div>
                </div>
              </div>
            {%- endfor -%}
          </div>
        </div>
      </div>
    {%- elsif tabs_item == 'visited' -%}
      <div
        id="t4s-tab-visited"
        data-cart-tab-content
        class="t4s-minicart-tabs-item-wrap"
        aria-hidden="{{ aria_hidden }}"
      >
        <div
          class="t4s-minicart-tabs-item-content t4s-current-scrollbar t4s-list-products-visited t4s_cover t4s_position_8 t4s_ratioadapt"
          data-t4s-scroll-me
        >
          <div class="t4s-mini_cart__emty t4s-text-center t4s-tab-visited-empty">
            {{ 'cart.mini_cart.empty_visited' | t }}
          </div>
          <div class="t4s-tab-visited-skeleton" style="display: none;">
            {%- for i in (1..5) -%}
              <div class="t4s-row t4s-space-item-inner t4s-widget__pr">
                <div class="t4s-col-item t4s-col t4s-widget_img_pr"><div class="t4s-skeleton_img"></div></div>
                <div class="t4s-col-item t4s-col t4s-widget_if_pr t4s-pr">
                  <div class="t4s-skeleton_txt1"></div>
                  <div class="t4s-skeleton_txt2"></div>
                </div>
              </div>
            {%- endfor -%}
          </div>
        </div>
      </div>
    {%- elsif tabs_item == 'cart' -%}
      <form
        id="t4s-tab-minicart"
        data-cart-ajax="{{ cart_ajax_enable }}"
        data-cart-tab-content
        action="{{ cart_url }}"
        method="post"
        novalidate
        class="t4s-minicart-tabs-item-wrap t4s-drawer__wrap !bg-[#F4F0E2] overflow-visible pt-8"
        aria-hidden="false"
      >
        <input type="hidden" data-cart-attr-rm name="attributes[collection_items_per_row]" value="">
        {%- if se_stts.enable_discount %}<input type="hidden" data-cart-discount name="discount" value="">{% endif -%}
        <div class="t4s-drawer__main">
          <div data-t4s-scroll-me class="t4s-drawer__scroll t4s-current-scrollbar bg-[#F4F0E2]">
            <div class="t4s-cookie-message t4s-dn">{{ 'cart.general.cookies_required' | t }}</div>
            {%- if se_style == '1' and se_pos == '1' %}{{- html_btn -}}{% endif -%}
            <div data-cart-items class="t4s-mini_cart__items t4s_ratioadapt !bg-[#F4F0E2]">
              {%- if ccount > 0 -%}
                {%- assign has_onetime = false -%}
                {%- assign has_subscription = false -%}
                {%- for item in cart.items -%}
                  {%- if item.selling_plan_allocation -%}
                    {%- assign has_subscription = true -%}
                  {%- else -%}
                    {%- assign has_onetime = true -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- if has_onetime -%}
                  <div class="mb-4 w-full border-b border-[#d9d9c8] pb-2">
                    <h3 class="font-['Barlow',Helvetica] font-bold text-[#004623] text-[14.6px] leading-[21.6px]">
                      Compras únicas
                    </h3>
                  </div>
                  <div class="cart-onetime mb-8">
                    {% for item in cart.items %}
                      {% unless item.selling_plan_allocation %}
                        {% render 'cart-item',
                          item: item,
                          gift_pr_id: gift_pr_id,
                          min_qty: min_qty,
                          compare_tt_price: compare_tt_price,
                          cart_change_url: cart_change_url,
                          edit_item: edit_item,
                          atc_ajax_enable: atc_ajax_enable,
                          cart_ajax_enable: cart_ajax_enable
                        %}
                      {% endunless %}
                    {% endfor %}
                  </div>
                {%- endif -%}

                {%- if has_subscription -%}
                  <div class="mb-4 w-full">
                    <h3 class="font-['Barlow',Helvetica] font-bold text-[#004623] text-[14.6px] leading-[21.6px]">
                      Subscripciones
                    </h3>
                    <div
                      data-orientation="horizontal"
                      role="none"
                      class="shrink-0 bg-border h-[1px] w-full mt-1 border-[#d9d9c8]"
                    ></div>
                  </div>
                  <div class="cart-subscription">
                    {% for item in cart.items %}
                      {% if item.selling_plan_allocation %}
                        {% render 'cart-item',
                          item: item,
                          gift_pr_id: gift_pr_id,
                          min_qty: min_qty,
                          compare_tt_price: compare_tt_price,
                          cart_change_url: cart_change_url,
                          edit_item: edit_item,
                          atc_ajax_enable: atc_ajax_enable,
                          cart_ajax_enable: cart_ajax_enable
                        %}
                      {% endif %}
                    {% endfor %}
                  </div>
                {%- endif -%}

              {%- else -%}
                <div class="t4s-mini_cart__emty">
                  <p>{{ 'cart.mini_cart.empty' | t }}</p>
                  {%- assign btn_blocks = section_blocks | where: 'type', 'btn' -%}
                  {%- if btn_blocks.size > 0 -%}
                    {%- for block in btn_blocks -%}
                      {%- assign bk_stts = block.settings -%}
                      {% if bk_stts.title == blank %}{% continue %}{% endif %}
                      <a
                        data-loading-bar
                        class="t4s-btn-cart__emty"
                        href="{{ block.settings.url | default: routes.all_products_collection_url }}"
                      >
                        {{- bk_stts.title -}}
                      </a>
                    {%- endfor -%}
                  {%- endif -%}
                </div>
              {%- endif -%}
            </div>
            {%- unless se_style == '1' and se_pos == '1' %}{{- html_btn -}}{% endunless -%}
            {%- if se_stts.enable_pr %}
              <div
                class="t4s-when-cart-emty"
                data-cart-upsell-options='{ "baseurl": "{{ routes.product_recommendations_url }}", "limit": 5, "product_id": {{ cart.items.first.product_id | default: 19041994 }}, "section_id": "mini_cart_upsell" }'
              ></div>
            {% endif -%}
          </div>
        </div>
        {%- comment -%} Reemplaza tu bloque <div class="t4s-drawer__bottom">…</div> por este snippet Tailwindizado {%- endcomment -%}

        <div class="relative z-10 border text-[#004623] w-full rounded-t-[16px] rounded-b-none border-t border-[#e7eeef] shadow-[0px_-2px_8px_#00000033] bg-white">
          <div class="flex flex-col items-start gap-8 px-4 py-10">
            <!-- Subtotal -->
            <div class="flex items-center justify-between w-full px-2">
              <div class="[font-family:'Barlow',Helvetica] text-[#004623] text-[16.7px] leading-[24.3px] font-bold">
                Subtotal (<span data-cart-count>{{ cart.item_count }}</span> artículo
                {%- if cart.item_count > 1 %}s{% endif -%}
                )
              </div>
              <div class="[font-family:'DM_Sans_18pt-Bold',Helvetica] font-bold text-[#004623] text-[16.2px] text-right leading-[24.3px]">
                <span data-cart-prices>{{ cart.total_price | money_without_trailing_zeros }}</span>
              </div>
            </div>

            <!-- Envío -->
            {%- if se_stts.enable_calc_ship and shipping_amount > -1 -%}
              {% assign ship_cost = shipping_amount | money_without_trailing_zeros %}
              <div class="flex items-center justify-between w-full  px-2">
                <div class="[font-family:'Barlow',Helvetica] text-[#004623] text-[16.7px] leading-[24.3px] font-medium">
                  Envío
                </div>
                <div class="[font-family:'DM_Sans_18pt-Bold',Helvetica] font-bold text-[#004623] text-[16.2px] text-right leading-[24.3px]">
                  {{ ship_cost }}
                </div>
              </div>
            {%- endif -%}

            <!-- Botón Ver la cesta -->
            <a
              href="{{ cart_url }}"
              data-view-cart
              class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 shadow px-4 w-full bg-[#ffcd00] hover:bg-[#ffcd00]/90 text-[#004623] rounded-[50px] py-[13px] h-auto"
            >
              <span class="[font-family:'DM_Sans_18pt-Bold',Helvetica] font-bold text-[14.6px] leading-4">
                Ver la cesta
              </span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-arrow-right ml-[5px] w-[16.66px] h-[16.66px]"
              >
                <path d="M5 12h14"></path>
                <path d="m12 5 7 7-7 7"></path>
              </svg>
            </a>
          </div>
        </div>
      </form>
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- if se_stts.enable_note -%}
  <div class="t4s-mini_cart-tool__content is--note t4s-pe-none">
    <label for="CartSpecialInstructions" class="t4s-d-block"
      ><span class="t4s-txt_add_note {{ style_add }}">{{ 'cart.tool.note' | t }}</span
      ><span class="t4s-txt_edit_note {{ style_edit }}">{{ 'cart.tool.edit_note' | t }}</span></label
    >
    <textarea
      name="note"
      data-opend-focus
      id="CartSpecialInstructions"
      placeholder="{{ 'cart.tool.placeholder_note' | t }}"
    >{{ cart.note }}</textarea>
    <button type="button" data-cart-tool_close class="button t4s-mini_cart-tool__primary">
      {{ 'cart.tool.save' | t }}
    </button>
    <button type="button" data-cart-tool_close class="t4s-mini_cart-tool__back">{{ 'cart.tool.cancel' | t }}</button>
  </div>
{%- endif -%}

{%- if se_stts.enable_rates -%}
  {%- assign idShip = 'mini_cart' -%}
  <div class="t4s-mini_cart-tool__content is--rates t4s-pe-none">
    <div class="t4s-mini_cart-tool__wrap" data-estimate-shipping-wrap data-id="{{ idShip }}">
      <span class="t4s-mini_cart-tool__text">{{ 'cart.shipping_estimator.title' | t }}</span>
      <div class="t4s-field">
        <label for="ShippingCountry_{{ idShip }}">{{ 'cart.shipping_estimator.country' | t }}</label>
        <select
          id="ShippingCountry_{{ idShip }}"
          name="country"
          data-default="{% if customer %}{{ customer.default_address.country }}{% elsif se_stts.ship_df_country != '' %}{{ se_stts.ship_df_country | escape }}{% endif %}"
        >
          {{- country_option_tags -}}
        </select>
      </div>
      <div class="t4s-field" id="ShippingProvinceContainer_{{ idShip }}" style="display: none">
        <label for="ShippingProvince_{{ idShip }}" id="address_province_label">
          {{- 'cart.shipping_estimator.province' | t -}}
        </label>
        <select
          id="ShippingProvince_{{ idShip }}"
          name="province"
          data-default="{% if customer %}{{ customer.default_address.province }}{% endif %}"
        ></select>
      </div>
      <div class="t4s-field">
        <label for="ShippingZip_{{ idShip }}">{{ 'cart.shipping_estimator.zip_code' | t }}</label>
        <input
          type="text"
          data-opend-focus
          id="ShippingZip_{{ idShip }}"
          name="zip"
          value="{% if customer %}{{ customer.default_address.zip }}{% endif %}"
        >
      </div>
      <div class="t4s-field">
        <button
          type="button"
          data-action="estimate-shipping"
          class="t4s-get__rates t4s-mini_cart-tool__primary t4s-btn-loading__svg"
        >
          <span class="t4s-btn-atc_text">{{ 'cart.shipping_estimator.estimate' | t }}</span>
          <div class="t4s-loading__spinner t4s-dn">
            <svg
              width="16"
              height="16"
              aria-hidden="true"
              focusable="false"
              role="presentation"
              class="t4s-svg__spinner"
              viewBox="0 0 66 66"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
            </svg>
          </div>
        </button>
        <button type="button" data-cart-tool_close class="t4s-mini_cart-tool__back">
          {{ 'cart.tool.cancel' | t }}
        </button>
      </div>
      <div data-response-rates class="t4s-response__rates"></div>
      <template data-lang-rates class="t4s-d-none">
        { "multiple_rates": {{ 'cart.shipping_estimator.multiple_rates' | t | json }}, "one_rate":
        {{ 'cart.shipping_estimator.one_rate' | t | json }}, "no_rates":
        {{ 'cart.shipping_estimator.no_rates' | t | json }}, "rate_value":
        {{ 'cart.shipping_estimator.rate_value' | t | json }}, "errors":
        {{ 'cart.shipping_estimator.errors' | t | json }}
        }
      </template>
    </div>
  </div>
{%- endif -%}

{%- if se_stts.enable_gift_wrap and gift_pr.available == true -%}
  <div class="t4s-mini_cart-tool__content is--gift t4s-pe-none">
    <div class="t4s-mini_cart-tool__wrap">
      <div class="t4s-field">
        <svg
          viewBox="0 0 24 24"
          width="24"
          height="24"
          stroke="currentColor"
          stroke-width="1.5"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="t4s-gift-svg"
        >
          <polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
        </svg>
        {%- assign gift_pr_money = gift_pr.variants.first.price | money -%}
        <span class="t4s-gift_wrap_text">{{ 'cart.tool.gift_wrap_html' | t: money: gift_pr_money }}</span>
      </div>
      <div class="t4s-field">
        <a
          href="{{ gift_pr.url }}"
          data-variant-id="{{ gift_pr.variants.first.id }}"
          data-action-atc
          data-add-gift
          class="t4s-mini_cart-tool__primary t4s-truncate"
        >
          <span class="t4s-txt-inner">{{ 'cart.tool.add_gift_wrap' | t }}</span>
          <span class="t4s-loading__spinner">
            <svg
              width="16"
              height="16"
              class="t4s-svg__spinner"
              focusable="false"
              role="presentation"
              viewBox="0 0 66 66"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
            </svg>
          </span>
        </a>
        <button type="button" data-cart-tool_close class="t4s-mini_cart-tool__back">
          {{ 'cart.tool.cancel' | t }}
        </button>
      </div>
    </div>
  </div>
{%- endif -%}

{%- if se_stts.enable_discount -%}
  <div class="t4s-mini_cart-tool__content is--discount t4s-pe-none">
    <div class="t4s-mini_cart-tool__wrap">
      <span class="t4s-mini_cart-tool__text">{{ 'cart.tool.add_coupon' | t }}</span>
      <p>{{ 'cart.tool.info_coupon' | t }}</p>
      <div class="t4s-field">
        <input
          type="text"
          data-opend-focus
          data-name="discount"
          id="CartDiscountcode"
          value
          placeholder="{{ 'cart.tool.placeholder_coupon' | t }}"
        >
      </div>
      <div class="t4s-field">
        <button type="button" data-action="save-discountcode" data-cart-tool_close class="t4s-mini_cart-tool__primary">
          {{ 'cart.tool.save' | t }}
        </button>
        <button type="button" data-cart-tool_close class="t4s-mini_cart-tool__back">
          {{ 'cart.tool.cancel' | t }}
        </button>
      </div>
    </div>
  </div>
{%- endif -%}

{%- if request.design_mode %}</div>{% endif -%}

<script>
  // Manejo robusto de cantidades en mini cart (compras únicas y suscripciones)
	  (function() {
	    const miniCart = document.getElementById('t4s-mini_cart');
	    if (!miniCart) return;

	    let isUpdating = false;
	    const viewCartBtn = miniCart.querySelector('[data-view-cart]');

	    const setViewCartDisabled = (disabled) => {
	      if (!viewCartBtn) return;
	      if (disabled) {
	        viewCartBtn.setAttribute('aria-disabled', 'true');
	        viewCartBtn.setAttribute('tabindex', '-1');
	        viewCartBtn.classList.add('t4s-pe-none', 't4s-op-50');
	      } else {
	        viewCartBtn.removeAttribute('aria-disabled');
	        viewCartBtn.removeAttribute('tabindex');
	        viewCartBtn.classList.remove('t4s-pe-none', 't4s-op-50');
	      }
	    };

	    if (viewCartBtn) {
	      viewCartBtn.addEventListener('click', (e) => {
	        if (viewCartBtn.getAttribute('aria-disabled') === 'true') {
	          e.preventDefault();
	          e.stopPropagation();
	          if (e.stopImmediatePropagation) e.stopImmediatePropagation();
	        }
	      });
	    }

	    const syncViewCartState = () => {
	      const needsPlan = Array.from(miniCart.querySelectorAll('[data-cart-item]')).some((itemEl) => {
	        const toggle = itemEl.querySelector('[data-selling-toggle]');
	        if (!toggle || !toggle.checked) return false;
	        const select = itemEl.querySelector('[data-selling-select]');
	        if (!select) return false;
	        return !select.value;
	      });
	      setViewCartDisabled(needsPlan || isUpdating);
	    };

	    const setQuantityDisabled = (disabled) => {
	      isUpdating = disabled;
	      miniCart.querySelectorAll('[data-quantity-selector], [data-quantity-value], [data-selling-toggle], [data-selling-select]').forEach(el => {
	        el.disabled = disabled;
        if (disabled) {
          el.classList.add('t4s-pe-none', 't4s-op-50');
        } else {
	          el.classList.remove('t4s-pe-none', 't4s-op-50');
	        }
	      });
	      syncViewCartState();
	    };

    const moneyFormat = {{ shop.money_format | json }};
    const formatMoney = (cents) => {
      try {
        if (window.Shopify && typeof window.Shopify.formatMoney === 'function') {
          return window.Shopify.formatMoney(cents, moneyFormat);
        }
      } catch (e) {}
      const value = (cents / 100).toFixed(2);
      // Formato simple: € y coma decimal
      return value.replace('.', ',') + '€';
    };

    const svgMinus = '<svg focusable="false" class="icon icon--minus m-auto" viewBox="0 0 10 2" role="presentation"><path d="M10 0v2H0V0z" fill="currentColor"></path></svg>';
    const svgTrash = '<svg class="m-auto" viewBox="0 0 24 24" width="17"><use href="#icon-cart-remove"></use></svg>';
    const syncMinusIcons = () => {
      miniCart.querySelectorAll('[data-quantity-wrapper]').forEach(wrapper => {
        const input = wrapper.querySelector('[data-quantity-value]');
        const minusBtn = wrapper.querySelector('.t4s-quantity-selector.is--minus');
        if (!input || !minusBtn) return;
        const qty = parseInt(input.value || '0', 10);
        minusBtn.innerHTML = qty > 1 ? svgMinus : svgTrash;
      });
    };

	    const syncPlanControls = (itemEl, sellingPlanId) => {
	      const toggle = itemEl.querySelector('[data-selling-toggle]');
	      const select = itemEl.querySelector('[data-selling-select]');
	      const wrap = itemEl.querySelector('[data-selling-select-wrap]');
	      const hasPlan = sellingPlanId && sellingPlanId !== '';
	      const isPending = itemEl.dataset.pendingSellingPlan === '1';
	      if (toggle) toggle.checked = hasPlan || isPending;
	      if (select) select.value = hasPlan ? String(sellingPlanId) : '';
	      if (wrap) {
	        if (hasPlan || (toggle && toggle.checked)) wrap.classList.remove('t4s-dn');
	        else wrap.classList.add('t4s-dn');
	      }
	    };

    const updateCartCount = (cart) => {
      if (!cart || typeof cart.item_count === 'undefined') return;
      document.querySelectorAll('[data-cart-count]').forEach((el) => {
        el.textContent = cart.item_count;
        if (cart.item_count > 0) {
          el.classList.remove('t4s-op-0');
        } else {
          el.classList.add('t4s-op-0');
        }
      });
    };

    const updateCartPrices = (cart) => {
      if (!cart || typeof cart.total_price === 'undefined') return;
      const formatted = formatMoney(cart.total_price);
      document.querySelectorAll('[data-cart-prices]').forEach((el) => {
        el.textContent = formatted;
      });
    };

    const updateLinePrices = (cart) => {
      if (!cart || !Array.isArray(cart.items)) return;
      cart.items.forEach((line) => {
        const key = line.key;
        const priceEl = document.querySelector(`[data-line-price][data-line-key="${key}"]`);
        if (priceEl) {
          priceEl.textContent = formatMoney(line.final_line_price);
        }
      });
    };

    const parsePriceValue = (text) => {
      if (!text) return 0;
      const cleaned = text.replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.');
      const value = parseFloat(cleaned);
      return Number.isNaN(value) ? 0 : value;
    };

    const triggerThemeCartRefresh = () => {
      try {
        if (window.T4SThemeSP && T4SThemeSP.Cart) {
          if (typeof T4SThemeSP.Cart.getCart === 'function') {
            T4SThemeSP.Cart.getCart();
            return;
          }
          if (typeof T4SThemeSP.Cart.updateCart === 'function') {
            T4SThemeSP.Cart.updateCart();
            return;
          }
        }
        document.dispatchEvent(new Event('cart:refresh'));
        document.dispatchEvent(new Event('t4s:cart:refresh'));
      } catch (e) {
        /* noop */
      }
    };
    
	    const syncLineDom = (itemEl, line) => {
	      if (!itemEl || !line) return;
	      const newKey = line.key;
	      const newKeySlug = newKey.replace(/:/g, '-');
      itemEl.dataset.key = newKey;
      itemEl.dataset.pid = newKey;
      itemEl.dataset.sellingPlan = line.selling_plan_allocation ? line.selling_plan_allocation.selling_plan.id : '';
      const currentPlan = itemEl.dataset.sellingPlan;
      // update helper class
      itemEl.classList.forEach(c => {
        if (c.startsWith('cart_item_key_')) itemEl.classList.remove(c);
      });
      itemEl.classList.add('cart_item_key_' + newKeySlug);

      const qtyInput = itemEl.querySelector('[data-quantity-value]');
      if (qtyInput) {
        qtyInput.value = line.quantity;
        qtyInput.dataset.id = newKey;
        qtyInput.id = 'miniupdates_' + newKey;
      }

      const priceEl = itemEl.querySelector('[data-line-price]');
      if (priceEl) {
        priceEl.dataset.lineKey = newKey;
        priceEl.textContent = formatMoney(line.final_line_price);
      }

      const removeLink = itemEl.querySelector('[data-cart-remove]');
	      if (removeLink) {
	        removeLink.dataset.id = newKey;
	        if (removeLink.href) {
	          removeLink.href = removeLink.href.replace(/id=[^&]+/, 'id=' + encodeURIComponent(newKey));
	        }
	      }

	      delete itemEl.dataset.pendingSellingPlan;
	      syncPlanControls(itemEl, currentPlan);
	      syncViewCartState();
	    };

    miniCart.addEventListener('click', function (event) {
      const btn = event.target.closest('[data-quantity-selector]');
      if (!btn) return;

      const itemEl = btn.closest('[data-cart-item]');
      if (!itemEl) return;
      const input = itemEl.querySelector('[data-quantity-value]');
      if (!input) return;
      if (isUpdating) {
        event.preventDefault();
        return;
      }

      event.preventDefault();
      event.stopPropagation();
      if (event.stopImmediatePropagation) event.stopImmediatePropagation();

      const key = itemEl.dataset.key || itemEl.dataset.pid || input.dataset.id;
      if (!key) return;

      const step = parseInt(input.step || '1', 10) || 1;
      const min = parseInt(input.min || '0', 10);
      const max = parseInt(input.max || '9999', 10);
      const current = parseInt(input.value || '0', 10);
      const isPlus = btn.classList.contains('is--plus');
      const isMinus = btn.classList.contains('is--minus');
      const delta = isPlus ? step : -step;

      let next;
      // Si está en 1 (icono de basura) y damos a minus, forzamos 0 para eliminar
      if (isMinus && current <= 1) {
        next = 0;
      } else {
        next = Math.max(min, Math.min(max, current + delta));
      }
      if (next === current) return;

      input.value = next;

      setQuantityDisabled(true);

      fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: key, quantity: next })
      })
        .then(res => res.json())
        .then(cart => {
          if (next === 0 && itemEl.parentNode) {
            const title = itemEl.querySelector('.t4s-mini_cart__title')?.textContent?.trim();
            const priceText =
              itemEl.querySelector('[data-line-price]')?.textContent ||
              itemEl.querySelector('.t4s-cart_price-total .t4s-cart_price')?.textContent ||
              '';
            const price = parsePriceValue(priceText);
            const removalId = itemEl.dataset.key || key;
            const vendor = itemEl.dataset.productVendor;
            const category = itemEl.dataset.productCollections || itemEl.dataset.productType;
            window.pushRemoveFromCartAnalytics?.({
              id: removalId,
              name: title,
              brand: vendor,
              category,
              price,
              quantity: current,
            });
            itemEl.parentNode.removeChild(itemEl);
          }
          updateCartCount(cart);
          updateCartPrices(cart);
          updateLinePrices(cart);
          triggerThemeCartRefresh();
          syncMinusIcons();
          setQuantityDisabled(false);
        })
        .catch(() => {
          setQuantityDisabled(false);
        });
    });

	    // Toggle suscripción / compra única
	    miniCart.addEventListener('change', function(event) {
	      const toggle = event.target.closest('[data-selling-toggle]');
	      const select = event.target.closest('[data-selling-select]');
	      if (!toggle && !select) return;

      const itemEl = (toggle || select).closest('[data-cart-item]');
      if (!itemEl) return;
	      if (isUpdating) {
	        event.preventDefault();
	        if (toggle) toggle.checked = !toggle.checked;
	        if (select) select.value = itemEl.dataset.sellingPlan || '';
	        return;
	      }

	      const key = itemEl.dataset.key;
	      const variantId = itemEl.dataset.variantId;
	      const qtyInput = itemEl.querySelector('[data-quantity-value]');
	      const qty = parseInt(qtyInput?.value || '1', 10);
	      const currentPlan = itemEl.dataset.sellingPlan || '';
	      const wrap = itemEl.querySelector('[data-selling-select-wrap]');
	      const selectEl = itemEl.querySelector('[data-selling-select]');

	      // 1) Checkbox: si marca, solo muestra el select (sin seleccionar nada) y bloquea "Ver la cesta"
	      if (toggle) {
	        if (toggle.checked) {
	          itemEl.dataset.pendingSellingPlan = '1';
	          if (wrap) wrap.classList.remove('t4s-dn');
	          if (selectEl) selectEl.value = '';
	          syncViewCartState();
	          return;
	        }

	        // Si desmarca: ocultamos el select y, si era suscripción real, la convertimos a compra única
	        delete itemEl.dataset.pendingSellingPlan;
	        if (wrap) wrap.classList.add('t4s-dn');
	        if (selectEl) selectEl.value = '';
	        syncViewCartState();

	        if (!currentPlan) return; // ya era compra única, no hacemos nada en backend
	        // Si tenía selling plan, pasar a compra única (remove + add sin plan)
	        setQuantityDisabled(true);
	        fetch('/cart/change.js', {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ id: key, quantity: 0 })
	        })
	          .then(() => fetch('/cart/add.js', {
	            method: 'POST',
	            headers: { 'Content-Type': 'application/json' },
	            body: JSON.stringify({ items: [{ id: variantId, quantity: qty }] })
	          }))
	          .then(() => fetch('/cart.js'))
	          .then(res => res.json())
	          .then(cart => {
	            const match = cart.items.find((line) => {
	              const linePlan = line.selling_plan_allocation ? String(line.selling_plan_allocation.selling_plan.id) : '';
	              return Number(line.variant_id) === Number(variantId) && linePlan === '';
	            });
	            if (match) syncLineDom(itemEl, match);
	            updateCartCount(cart);
	            updateCartPrices(cart);
	            updateLinePrices(cart);
	            triggerThemeCartRefresh();
	            syncMinusIcons();
	            setQuantityDisabled(false);
	          })
	          .catch(() => {
	            setQuantityDisabled(false);
	            syncPlanControls(itemEl, itemEl.dataset.sellingPlan || '');
	          });
	        return;
	      }

	      // 2) Select: si elige una frecuencia, aplicamos el selling plan (remove + add con plan)
	      if (!select) return;
	      const sellingPlanId = select.value;
	      if (!sellingPlanId) {
	        syncViewCartState();
	        return;
	      }

	      // Marcamos el toggle como suscripción y limpiamos estado pendiente
	      const toggleEl = itemEl.querySelector('[data-selling-toggle]');
	      if (toggleEl) toggleEl.checked = true;
	      delete itemEl.dataset.pendingSellingPlan;
	      if (wrap) wrap.classList.remove('t4s-dn');

	      if (String(currentPlan) === String(sellingPlanId)) {
	        syncViewCartState();
	        return;
	      }

	      setQuantityDisabled(true);

	      fetch('/cart/change.js', {
	        method: 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify({ id: key, quantity: 0 })
	      })
	        .then(() => fetch('/cart/add.js', {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json' },
	          body: JSON.stringify({ items: [{ id: variantId, quantity: qty, selling_plan: sellingPlanId }] })
	        }))
	        .then(() => fetch('/cart.js'))
	        .then(res => res.json())
	        .then(cart => {
	          const match = cart.items.find((line) => {
	            const linePlan = line.selling_plan_allocation ? String(line.selling_plan_allocation.selling_plan.id) : '';
	            return Number(line.variant_id) === Number(variantId) && linePlan === String(sellingPlanId);
	          });
	          if (match) {
	            syncLineDom(itemEl, match);
	          }
	          updateCartCount(cart);
	          updateCartPrices(cart);
	          updateLinePrices(cart);
	          triggerThemeCartRefresh();
	          syncMinusIcons();
	          setQuantityDisabled(false);
	        })
	        .catch(() => {
	          setQuantityDisabled(false);
	          syncPlanControls(itemEl, itemEl.dataset.sellingPlan || '');
	        });
	    });

	    // Sincroniza iconos al iniciar y en cambios manuales
	    syncMinusIcons();
	    syncViewCartState();
	    miniCart.addEventListener('input', function(event) {
	      if (event.target && event.target.matches('[data-quantity-value]')) {
	        syncMinusIcons();
	      }
	    });
  })();
</script>

{% schema %}
{
  "name": "Shopping Cart Widget",
  "class": "t4s_tp_cdt t4s_tp_tab",
  "max_blocks": 20,
  "settings": [
    {
  "type": "header",
  "content": "Announcement Bar"
},
{
  "type": "richtext",
  "id": "announcement_rich_text",
  "label": "Texto del anuncio",
  "default": "<p>Envío gratis en pedidos superiores a <strong>50€</strong></p>"
},
{
  "type": "color",
  "id": "announcement_bg_color",
  "label": "Color de fondo del anuncio",
  "default": "#004622"
},
{
  "type": "color",
  "id": "announcement_text_color",
  "label": "Color del texto del anuncio",
  "default": "#ffffff"
},
{
  "type": "range",
  "id": "announcement_padding_top_mobile",
  "min": 0,
  "max": 100,
  "step": 2,
  "unit": "px",
  "label": "Padding superior (móvil)",
  "default": 12
},
{
  "type": "range",
  "id": "announcement_padding_bottom_mobile",
  "min": 0,
  "max": 100,
  "step": 2,
  "unit": "px",
  "label": "Padding inferior (móvil)",
  "default": 12
},
{
  "type": "range",
  "id": "announcement_padding_top_desktop",
  "min": 0,
  "max": 100,
  "step": 2,
  "unit": "px",
  "label": "Padding superior (desktop)",
  "default": 16
},
{
  "type": "range",
  "id": "announcement_padding_bottom_desktop",
  "min": 0,
  "max": 100,
  "step": 2,
  "unit": "px",
  "label": "Padding inferior (desktop)",
  "default": 16
},
{
  "type": "range",
  "id": "announcement_margin_top",
  "min": 0,
  "max": 100,
  "step": 2,
  "unit": "px",
  "label": "Margen superior",
  "default": 0
},
{
  "type": "range",
  "id": "announcement_margin_bottom",
  "min": 0,
  "max": 100,
  "step": 2,
  "unit": "px",
  "label": "Margen inferior",
  "default": 0
},
{
  "type": "range",
  "id": "announcement_font_size_mobile",
  "min": 10,
  "max": 30,
  "step": 1,
  "unit": "px",
  "label": "Tamaño de letra (móvil)",
  "default": 14
},
{
  "type": "range",
  "id": "announcement_font_size_desktop",
  "min": 10,
  "max": 40,
  "step": 1,
  "unit": "px",
  "label": "Tamaño de letra (desktop)",
  "default": 16
},
    {
      "type": "header",
      "content": "+ Mini cart tabs"
    },
    {
      "type": "text",
      "id": "tabs_list",
      "label": "Featured collection heading",
      "info": "Enter 1 or more items from left to right in the  list below to display tab list for mini cart order. Items are separated by commas \",\". The list is: best_seller, wishlist, visited, cart ",
      "placeholder": "best_seller, wishlist, visited, cart",
      "default": "best_seller, wishlist, visited, cart"
    },
    {
      "id": "product_list",
      "type": "product_list",
      "label": "Products best seller",
      "info": "Select your best seller product. Only show when \"best_seller\" is choosen",
      "label": "Featured products"
    },
    {
      "type": "paragraph",
      "content": "------------------------------"
    },
    {
      "type": "paragraph",
      "content": "Those settings are only applicable when the cart contains at least one product."
    },
    {
      "type": "select",
      "id": "style",
      "options": [
        { "value": "1", "label": "Icon" },
        { "value": "2", "label": "Button text" }
      ],
      "label": "Buttons style:"
    },
    {
      "type": "select",
      "id": "pos",
      "default": "2",
      "options": [
        { "value": "1", "label": "Top" },
        { "value": "2", "label": "Bottom" }
      ],
      "info": "Only working with button style icon",
      "label": "Position button icon"
    },
    {
      "type": "checkbox",
      "id": "enable_pr",
      "label": "Enable product recommendations",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_calc_ship",
      "label": "Enable calc shipping",
      "info": "Free shipping minimum amount.",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_note",
      "label": "Enable order notes",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_rates",
      "label": "Enable shipping rates calculator",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_discount",
      "label": "Enable input box discounts codes",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_gift_wrap",
      "label": "Enable gift wrap",
      "default": true
    },
    {
      "type": "header",
      "content": "+ Shipping Rates Calculator"
    },
    {
      "type": "text",
      "id": "ship_df_country",
      "label": "Default country selection",
      "default": "United States"
    },
    {
      "type": "paragraph",
      "content": "If your customer is logged-in, the country in his default shipping address will be selected. If you are not sure about the  spelling to use here, refer to the first checkout page."
    }
  ],
  "blocks": [
    {
      "type": "price",
      "name": "Total price",
      "limit": 1
    },
    {
      "type": "tax",
      "name": "Taxes and shipping info",
      "limit": 1 /*,
        "settings": [
          {
            "type": "richtext",
            "id": "image",
            "label": "Content"
          }
        ]*/
    },
    {
      "type": "agree",
      "name": "Terms,conditions checkbox",
      "limit": 1
    },
    {
      "type": "group_btns",
      "name": "Buttons",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "btn_viewcart",
          "label": "Enable \"View cart\" button",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "btn_checkout",
          "label": "Enable \"Checkout\" button",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "btn_icon",
          "label": "Enable button icon",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "btn_inline",
          "label": "Enable buttons inline",
          "default": true
        },
        {
          "type": "header",
          "content": "+ View cart button options"
        },
        {
          "type": "select",
          "id": "cart_button_style",
          "label": "Button style",
          "options": [
            {
              "label": "Default",
              "value": "default"
            },
            {
              "label": "Outline",
              "value": "outline"
            },
            {
              "label": "Bordered bottom",
              "value": "bordered"
            },
            {
              "label": "Link",
              "value": "link"
            }
          ],
          "default": "outline"
        },
        {
          "type": "select",
          "id": "cart_btn_cl",
          "label": "Button color",
          "default": "dark",
          "options": [
            {
              "value": "light",
              "label": "Light"
            },
            {
              "value": "dark",
              "label": "Dark"
            },
            {
              "value": "primary",
              "label": "Primary"
            },
            {
              "value": "custom1",
              "label": "Custom color 1"
            },
            {
              "value": "custom2",
              "label": "Custom color 2"
            }
          ]
        },
        {
          "type": "select",
          "id": "cart_button_effect",
          "label": "Hover button effect",
          "default": "default",
          "info": "Only working button style default, outline",
          "options": [
            {
              "label": "Default",
              "value": "default"
            },
            {
              "label": "Fade",
              "value": "fade"
            },
            {
              "label": "Rectangle out",
              "value": "rectangle-out"
            },
            {
              "label": "Sweep to right",
              "value": "sweep-to-right"
            },
            {
              "label": "Sweep to left",
              "value": "sweep-to-left"
            },
            {
              "label": "Sweep to bottom",
              "value": "sweep-to-bottom"
            },
            {
              "label": "Sweep to top",
              "value": "sweep-to-top"
            },
            {
              "label": "Shutter out horizontal",
              "value": "shutter-out-horizontal"
            },
            {
              "label": "Outline",
              "value": "outline"
            },
            {
              "label": "Shadow",
              "value": "shadow"
            }
          ]
        },
        {
          "type": "header",
          "content": "+ Checkout button options"
        },
        {
          "type": "select",
          "id": "button_style",
          "label": "Button style",
          "options": [
            {
              "label": "Default",
              "value": "default"
            },
            {
              "label": "Outline",
              "value": "outline"
            },
            {
              "label": "Bordered bottom",
              "value": "bordered"
            },
            {
              "label": "Link",
              "value": "link"
            }
          ]
        },
        {
          "type": "select",
          "id": "btn_cl",
          "label": "Button color",
          "default": "dark",
          "options": [
            {
              "value": "light",
              "label": "Light"
            },
            {
              "value": "dark",
              "label": "Dark"
            },
            {
              "value": "primary",
              "label": "Primary"
            },
            {
              "value": "custom1",
              "label": "Custom color 1"
            },
            {
              "value": "custom2",
              "label": "Custom color 2"
            }
          ]
        },
        {
          "type": "select",
          "id": "button_effect",
          "label": "Hover button effect",
          "default": "default",
          "info": "Only working button style default, outline",
          "options": [
            {
              "label": "Default",
              "value": "default"
            },
            {
              "label": "Fade",
              "value": "fade"
            },
            {
              "label": "Rectangle out",
              "value": "rectangle-out"
            },
            {
              "label": "Sweep to right",
              "value": "sweep-to-right"
            },
            {
              "label": "Sweep to left",
              "value": "sweep-to-left"
            },
            {
              "label": "Sweep to bottom",
              "value": "sweep-to-bottom"
            },
            {
              "label": "Sweep to top",
              "value": "sweep-to-top"
            },
            {
              "label": "Shutter out horizontal",
              "value": "shutter-out-horizontal"
            },
            {
              "label": "Outline",
              "value": "outline"
            },
            {
              "label": "Shadow",
              "value": "shadow"
            }
          ]
        }
      ]
    },
    {
      "type": "img",
      "name": "Image trust",
      "limit": 1,
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    },
    {
      "type": "btn",
      "name": "Button emty",
      "settings": [
        {
          "type": "paragraph",
          "content": "Note: Only show when cart empty."
        },
        {
          "type": "text",
          "id": "title",
          "label": "Button Title",
          "default": "Return To Shop",
          "info": "If set blank will not show"
        },
        {
          "type": "url",
          "id": "url",
          "label": "Button link"
        }
      ]
    }
  ],
  "default": {
    "blocks": [
      { "type": "price" },
      { "type": "tax" },
      { "type": "agree" },
      { "type": "group_btns" },
      { "type": "img" },
      { "type": "btn" }
    ]
  }
}
{% endschema %}
