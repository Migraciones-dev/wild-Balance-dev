<section
  id="section-{{ section.id }}"
  class="w-full"
  style="
    background-color: {{ section.settings.bg_color }};
    padding-top: {{ section.settings.pt_mobile }}px;
    padding-bottom: {{ section.settings.pb_mobile }}px;
  "
>
  <style>
    @media (min-width: 768px) {
      #section-{{ section.id }} {
        padding-top: {{ section.settings.pt_desktop }}px !important;
        padding-bottom: {{ section.settings.pb_desktop }}px !important;
      }
    }

    #section-{{ section.id }} h2 {
      color: {{ section.settings.title_color }};
      padding-top: {{ section.settings.title_pt_mobile }}px;
      padding-bottom: {{ section.settings.title_pb_mobile }}px;
    }

    @media (min-width: 768px) {
      #section-{{ section.id }} h2 {
        padding-top: {{ section.settings.title_pt_desktop }}px !important;
        padding-bottom: {{ section.settings.title_pb_desktop }}px !important;
      }
    }

    .countdown-timer {
      background-color: {{ section.settings.countdown_bg_color }};
      color: {{ section.settings.countdown_text_color }};
      padding: 8px 16px;
      border-radius: 50px;
      font-family: 'Arial', sans-serif;
      font-weight: bold;
      font-size: 14px;
      display: inline-block;
      position: absolute;
      z-index: 2;
    }

    /* Posición en móvil: esquina superior derecha */
    .countdown-timer {
      top: 12px;
      right: 12px;
    }

    /* Posición en desktop: centro superior */
    @media (min-width: 768px) {
      .countdown-timer {
        top: 16px;
        left: 50%;
        right: auto;
        transform: translateX(-50%);
      }
    }

    .banner-clickable {
      cursor: pointer;
      position: relative;
      display: block;
    }

    {% for block in section.blocks %}
      @media (min-width: 768px) {
        #banner-{{ block.id }} .banner-image {
          border-radius: {{ block.settings.border_radius_desktop }}px !important;
        }
      }

      @media (max-width: 767px) {
        #banner-{{ block.id }} .banner-image {
          border-radius: {{ block.settings.border_radius_mobile }}px !important;
        }
      }

      #banner-{{ block.id }} {
        margin-top: {{ block.settings.mt_mobile }}px;
        margin-bottom: {{ block.settings.mb_mobile }}px;
      }

      @media (min-width: 768px) {
        #banner-{{ block.id }} {
          margin-top: {{ block.settings.mt_desktop }}px !important;
          margin-bottom: {{ block.settings.mb_desktop }}px !important;
        }
      }
    {% endfor %}
  </style>

  <div class="max-w-[1600px] mx-auto px-6 lg:px-10">
    {%- comment -%} Título con highlight {%- endcomment -%}
    {% if section.settings.heading_before != blank
      or section.settings.heading_highlight != blank
      or section.settings.heading_after != blank
    %}
      <div class="text-center">
        <h2 class="[font-family:'Barlow',Helvetica] font-extrabold text-[30px] sm:text-[38px] md:text-[44px] lg:text-[57px] xl:text-[64px] leading-[1]">
          {{ section.settings.heading_before }}
          {% if section.settings.heading_highlight != blank %}
            <span class="highlight">{{ section.settings.heading_highlight }}</span>
          {% endif %}
          {{ section.settings.heading_after }}
        </h2>
      </div>
    {% endif %}

    {%- comment -%} Grid de banners {%- endcomment -%}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8">
      {% for block in section.blocks %}
        {% if block.type == 'banner' %}
          {%- comment -%} Convertir fechas a timestamp Unix para comparación {%- endcomment -%}
          {%- assign current_time = 'now' | date: '%s' | plus: 0 -%}

          {%- comment -%} Procesar fechas ingresadas {%- endcomment -%}
          {%- assign show_banner = false -%}

          {%- if block.settings.enable_schedule == false -%}
            {%- assign show_banner = true -%}
          {%- else -%}
            {%- assign has_start = false -%}
            {%- assign has_end = false -%}

            {%- if block.settings.start_date != blank -%}
              {%- assign has_start = true -%}
              {%- assign start_time = block.settings.start_date | append: ':00' | date: '%s' | plus: 0 -%}
            {%- endif -%}

            {%- if block.settings.end_date != blank -%}
              {%- assign has_end = true -%}
              {%- assign end_time = block.settings.end_date | append: ':00' | date: '%s' | plus: 0 -%}
            {%- endif -%}

            {%- if has_start and has_end -%}
              {%- if current_time >= start_time and current_time <= end_time -%}
                {%- assign show_banner = true -%}
              {%- endif -%}
            {%- elsif has_start and has_end == false -%}
              {%- if current_time >= start_time -%}
                {%- assign show_banner = true -%}
              {%- endif -%}
            {%- elsif has_start == false and has_end -%}
              {%- if current_time <= end_time -%}
                {%- assign show_banner = true -%}
              {%- endif -%}
            {%- else -%}
              {%- assign show_banner = true -%}
            {%- endif -%}
          {%- endif -%}

          {%- if show_banner -%}
            {%- comment -%} Obtener producto si está asignado {%- endcomment -%}
            {%- assign banner_product = block.settings.product -%}

            <div id="banner-{{ block.id }}" class="relative" {{ block.shopify_attributes }}>
              {%- comment -%} Cuenta atrás {%- endcomment -%}
              {% if block.settings.enable_countdown and block.settings.countdown_date != blank %}
                <div class="countdown-timer" data-countdown-date="{{ block.settings.countdown_date }}">00:00:00</div>
              {% endif %}

              {%- comment -%} Determinar si es link o añadir al carrito {%- endcomment -%}
              {% if banner_product and banner_product != blank %}
                {%- assign current_variant = banner_product.selected_or_first_available_variant -%}
                <div
                  class="banner-clickable"
                  data-banner-product
                  data-variant-id="{{ current_variant.id }}"
                  data-product-id="{{ banner_product.id }}"
                  data-product-available="{{ banner_product.available }}"
                >
              {% elsif block.settings.image_link != blank %}
                <a href="{{ block.settings.image_link }}" class="banner-clickable">
              {% else %}
                <div class="banner-clickable" style="cursor: default;">
              {% endif %}

              {%- if block.settings.desktop_image or block.settings.mobile_image -%}
                {%- comment -%} Si hay imagen de móvil, usar responsive, si no, mostrar la de desktop en todos lados {%- endcomment -%}
                {% if block.settings.mobile_image %}
                  {%- comment -%} Imagen escritorio {%- endcomment -%}
                  {% if block.settings.desktop_image %}
                    <img
                      src="{{ block.settings.desktop_image | img_url: '2048x' }}"
                      class="banner-image hidden md:block w-full h-auto object-cover"
                      alt="{{ block.settings.desktop_image.alt | escape }}"
                      loading="lazy"
                    >
                  {% endif %}

                  {%- comment -%} Imagen móvil {%- endcomment -%}
                  <img
                    src="{{ block.settings.mobile_image | img_url: '1024x' }}"
                    class="banner-image block md:hidden w-full h-auto object-cover"
                    alt="{{ block.settings.mobile_image.alt | escape }}"
                    loading="lazy"
                  >
                {% else %}
                  {%- comment -%} Solo hay imagen desktop, mostrarla en todos los dispositivos {%- endcomment -%}
                  {% if block.settings.desktop_image %}
                    <img
                      src="{{ block.settings.desktop_image | img_url: '2048x' }}"
                      class="banner-image w-full h-auto object-cover"
                      alt="{{ block.settings.desktop_image.alt | escape }}"
                      loading="lazy"
                    >
                  {% endif %}
                {% endif %}
              {%- endif -%}

              {% if banner_product and banner_product != blank %}
                </div>
              {% elsif block.settings.image_link != blank %}
                </a>
              {% else %}
                </div>
              {% endif %}
            </div>
          {%- endif -%}
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Countdown timers
    const countdownTimers = document.querySelectorAll('.countdown-timer');

    countdownTimers.forEach((timer) => {
      const endDateStr = timer.getAttribute('data-countdown-date');
      if (!endDateStr) return;

      const endDate = new Date(endDateStr + ':00').getTime();

      function updateCountdown() {
        const now = new Date().getTime();
        const distance = endDate - now;

        if (distance < 0) {
          timer.textContent = '00:00:00';
          clearInterval(interval);
          return;
        }

        const totalHours = Math.floor(distance / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        const hoursStr = totalHours.toString().padStart(2, '0');
        const minutesStr = minutes.toString().padStart(2, '0');
        const secondsStr = seconds.toString().padStart(2, '0');

        timer.textContent = `${hoursStr}:${minutesStr}:${secondsStr}`;
      }

      updateCountdown();
      const interval = setInterval(updateCountdown, 1000);
    });

    // Add to cart functionality
    const productBanners = document.querySelectorAll('[data-banner-product]');

    productBanners.forEach((banner) => {
      banner.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        const variantId = this.getAttribute('data-variant-id');
        const productAvailable = this.getAttribute('data-product-available') === 'true';

        if (!productAvailable) {
          console.log('Producto no disponible');
          return;
        }

        // Usar el formato que espera el tema
        const formData = {
          items: [
            {
              id: variantId,
              quantity: 1,
            },
          ],
        };

        // Añadir al carrito
        fetch(window.Shopify.routes.root + 'cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Accept: 'application/json',
          },
          body: JSON.stringify(formData),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Producto añadido:', data);

            // Disparar el evento que el tema escucha para actualizar el carrito
            document.dispatchEvent(new CustomEvent('cart:refresh'));

            // Simular click en el botón del carrito para abrir el drawer correctamente
            setTimeout(() => {
              const cartButton = document.querySelector('[data-drawer-options*="t4s-mini_cart"]');
              if (cartButton) {
                cartButton.click();
              }
            }, 100);
          })
          .catch((error) => {
            console.error('Error añadiendo al carrito:', error);
          });
      });
    });
  });
</script>

{% schema %}
{
  "name": "Banners Grid 2 columnas",
  "settings": [
    {
      "type": "paragraph",
      "content": "⚠️ IMPORTANTE: Asegúrate de que la zona horaria de tu tienda esté configurada en 'Madrid' o '(GMT+01:00) Europe/Madrid' en Configuración > General > Estándares y formatos"
    },
    {
      "type": "header",
      "content": "Título"
    },
    {
      "type": "text",
      "id": "heading_before",
      "label": "Título (antes del resaltado)",
      "default": "Descubre nuestras"
    },
    {
      "type": "text",
      "id": "heading_highlight",
      "label": "Texto resaltado",
      "default": "ofertas especiales"
    },
    {
      "type": "text",
      "id": "heading_after",
      "label": "Título (después del resaltado)"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Color del título",
      "default": "#004622"
    },
    {
      "type": "header",
      "content": "Espaciado del título - Desktop"
    },
    {
      "type": "range",
      "id": "title_pt_desktop",
      "label": "Padding superior del título (Desktop)",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "title_pb_desktop",
      "label": "Padding inferior del título (Desktop)",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 48
    },
    {
      "type": "header",
      "content": "Espaciado del título - Móvil"
    },
    {
      "type": "range",
      "id": "title_pt_mobile",
      "label": "Padding superior del título (Móvil)",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "title_pb_mobile",
      "label": "Padding inferior del título (Móvil)",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 32
    },
    {
      "type": "header",
      "content": "🎨 Colores - Countdown Badge"
    },
    {
      "type": "color",
      "id": "countdown_bg_color",
      "label": "Color de fondo del countdown",
      "default": "#F0807B"
    },
    {
      "type": "color",
      "id": "countdown_text_color",
      "label": "Color del texto del countdown",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Espaciado de sección - Desktop"
    },
    {
      "type": "range",
      "id": "pt_desktop",
      "label": "Padding superior (Desktop)",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "pb_desktop",
      "label": "Padding inferior (Desktop)",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "header",
      "content": "Espaciado de sección - Móvil"
    },
    {
      "type": "range",
      "id": "pt_mobile",
      "label": "Padding superior (Móvil)",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "pb_mobile",
      "label": "Padding inferior (Móvil)",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "default": 20
    },
    {
      "type": "header",
      "content": "Estilo"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Color de fondo de la sección",
      "default": "#FBF5E7"
    }
  ],
  "blocks": [
    {
      "type": "banner",
      "name": "Banner",
      "settings": [
        {
          "type": "header",
          "content": "Imágenes"
        },
        {
          "type": "image_picker",
          "id": "desktop_image",
          "label": "Imagen escritorio"
        },
        {
          "type": "image_picker",
          "id": "mobile_image",
          "label": "Imagen móvil (opcional)",
          "info": "Si no se añade, se mostrará la imagen de escritorio en móvil"
        },
        {
          "type": "url",
          "id": "image_link",
          "label": "Enlace de la imagen (solo si no hay producto)",
          "info": "Este enlace solo funciona si NO hay producto seleccionado"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Producto (añadir al carrito)",
          "info": "Si seleccionas un producto, al hacer click se añadirá al carrito. Si no, usa el enlace normal."
        },
        {
          "type": "header",
          "content": "⏰ Cuenta atrás"
        },
        {
          "type": "checkbox",
          "id": "enable_countdown",
          "label": "Activar cuenta atrás",
          "default": false,
          "info": "Muestra una cuenta atrás en formato HH:MM:SS"
        },
        {
          "type": "text",
          "id": "countdown_date",
          "label": "⏱️ Fecha y hora final de cuenta atrás",
          "placeholder": "2025-12-20 23:00",
          "info": "Formato: YYYY-MM-DD HH:MM (ejemplo: 2025-12-20 23:00). Al terminar mostrará 00:00:00"
        },
        {
          "type": "header",
          "content": "⏰ Programación de visualización (Hora de España)"
        },
        {
          "type": "checkbox",
          "id": "enable_schedule",
          "label": "Activar programación de fechas",
          "default": false,
          "info": "Activa para programar cuándo se mostrará este banner"
        },
        {
          "type": "text",
          "id": "start_date",
          "label": "📅 Fecha y hora de INICIO (España)",
          "placeholder": "2025-11-29 10:30",
          "info": "Formato: YYYY-MM-DD HH:MM (ejemplo: 2025-11-29 10:30). Hora de España (CET/CEST). Dejar vacío = desde siempre"
        },
        {
          "type": "text",
          "id": "end_date",
          "label": "📅 Fecha y hora de FIN (España)",
          "placeholder": "2025-12-20 23:00",
          "info": "Formato: YYYY-MM-DD HH:MM (ejemplo: 2025-12-20 23:00). Hora de España (CET/CEST). Dejar vacío = sin límite"
        },
        {
          "type": "header",
          "content": "Border Radius"
        },
        {
          "type": "range",
          "id": "border_radius_desktop",
          "label": "Border radius (Desktop)",
          "min": 0,
          "max": 50,
          "step": 2,
          "unit": "px",
          "default": 30
        },
        {
          "type": "range",
          "id": "border_radius_mobile",
          "label": "Border radius (Móvil)",
          "min": 0,
          "max": 50,
          "step": 2,
          "unit": "px",
          "default": 12
        },
        {
          "type": "header",
          "content": "Espaciado - Desktop"
        },
        {
          "type": "range",
          "id": "mt_desktop",
          "label": "Margen superior (Desktop)",
          "min": 0,
          "max": 200,
          "step": 4,
          "unit": "px",
          "default": 0
        },
        {
          "type": "range",
          "id": "mb_desktop",
          "label": "Margen inferior (Desktop)",
          "min": 0,
          "max": 200,
          "step": 4,
          "unit": "px",
          "default": 0
        },
        {
          "type": "header",
          "content": "Espaciado - Móvil"
        },
        {
          "type": "range",
          "id": "mt_mobile",
          "label": "Margen superior (Móvil)",
          "min": 0,
          "max": 200,
          "step": 4,
          "unit": "px",
          "default": 0
        },
        {
          "type": "range",
          "id": "mb_mobile",
          "label": "Margen inferior (Móvil)",
          "min": 0,
          "max": 200,
          "step": 4,
          "unit": "px",
          "default": 0
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Banners Grid 2 columnas",
      "blocks": [
        {
          "type": "banner"
        },
        {
          "type": "banner"
        }
      ]
    }
  ]
}
{% endschema %}
