{%- liquid
  assign show_teaser = true
  
  # 1. Lógica de visualización por colección
  if section.settings.target_collection != blank
    assign show_teaser = false
    # Si estamos en la página de colección y coincide
    if template contains 'collection' and collection.handle == section.settings.target_collection
      assign show_teaser = true
    # Si estamos en un producto y pertenece a la colección
    elsif template contains 'product'
      for col in product.collections
        if col.handle == section.settings.target_collection
          assign show_teaser = true
          break
        endif
      endfor
    endif
  endif

  # 2. Lógica de posicionamiento (Tailwind classes)
  case section.settings.position
    when 'bottom_left'
      assign position_classes = 'bottom-6 left-6'
    when 'bottom_right'
      assign position_classes = 'bottom-6 right-6'
    when 'bottom_center'
      assign position_classes = 'bottom-6 left-1/2 -translate-x-1/2'
  endcase
-%}

{%- if show_teaser or request.design_mode -%}
<div
  id="wild-teaser-{{ section.id }}"
  class="fixed {{ position_classes }} z-[9999] transition-all duration-500 ease-out transform translate-y-8 opacity-0"
  style="display: none;" 
  role="dialog"
  aria-label="Oferta especial"
>
  <!-- Contenedor Relativo para posicionar la X -->
  <div class="relative group">
    
    <!-- Enlace principal (Pill Shape) -->
    <a 
      href="{{ section.settings.link }}" 
      class="flex items-center justify-center px-8 py-3 rounded-full shadow-xl hover:shadow-2xl transition-shadow cursor-pointer no-underline"
      style="background-color: {{ section.settings.bg_color }}; color: {{ section.settings.text_color }};"
    >
      <span class="[font-family:'Barlow',sans-serif] font-extrabold text-[11px] lg:text-[16px] tracking-wider uppercase leading-none">
        {{ section.settings.text }}
      </span>
    </a>

    <!-- Botón de cerrar (X pequeña) -->
    <button
      type="button"
      onclick="closeWildTeaser('{{ section.id }}')"
      class="absolute -top-2 -right-2 rounded-full p-1 shadow-md hover:opacity-90 transition-colors cursor-pointer flex items-center justify-center w-6 h-6"
      style="background-color: {{ section.settings.close_bg_color }}; color: {{ section.settings.close_icon_color }};"
      aria-label="Cerrar oferta"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

  </div>
</div>

<script>
  (function() {
    function initTeaser() {
      var teaserId = 'wild-teaser-{{ section.id }}';
      var teaserElement = document.getElementById(teaserId);
      if (!teaserElement) return;

      // Detectar si estamos en el editor de Shopify
      var isDesignMode = false;
      if (window.Shopify && window.Shopify.designMode) {
        isDesignMode = true;
      }

      // Lógica de visualización:
      // Si es modo diseño (editor) -> MOSTRAR SIEMPRE (ignora sessionStorage)
      // Si es web real -> Comprobar sessionStorage
      if (isDesignMode || !sessionStorage.getItem('wild_teaser_closed_' + '{{ section.id }}')) {
        teaserElement.style.display = 'block';
        
        // Pequeño timeout para permitir que el display:block se renderice antes de la transición de opacidad
        setTimeout(function() {
          teaserElement.classList.remove('translate-y-8', 'opacity-0');
        }, 100);
      }
    }

    // Ejecutar al cargar
    initTeaser();

    // Escuchar eventos del editor de Shopify para recargar sin F5
    document.addEventListener("shopify:section:load", initTeaser);
    document.addEventListener("shopify:section:select", initTeaser);
  })();

  function closeWildTeaser(id) {
    var teaserElement = document.getElementById('wild-teaser-' + id);
    if (teaserElement) {
      // Animación de salida
      teaserElement.classList.add('opacity-0', 'translate-y-8');
      
      setTimeout(function() {
        teaserElement.style.display = 'none';
      }, 500);

      // Solo guardamos en sessionStorage si NO estamos editando, 
      // para no "romper" la vista previa del editor permanentemente.
      if (!window.Shopify || !window.Shopify.designMode) {
        sessionStorage.setItem('wild_teaser_closed_' + id, 'true');
      }
    }
  }
</script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@800&display=swap');
</style>
{%- endif -%}

{% schema %}
{
  "name": "Teaser Popup",
  "tag": "section",
  "class": "section-wild-teaser",
  "settings": [
    {
      "type": "header",
      "content": "Contenido"
    },
    {
      "type": "text",
      "id": "text",
      "label": "Texto del Botón",
      "default": "GET 10% OFF"
    },
    {
      "type": "url",
      "id": "link",
      "label": "Enlace de destino"
    },
    {
      "type": "header",
      "content": "Colores Principales"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Fondo del Teaser",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Color del Texto",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Botón de Cerrar (X)"
    },
    {
      "type": "color",
      "id": "close_bg_color",
      "label": "Fondo Botón Cerrar",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "close_icon_color",
      "label": "Color Icono X",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Posición y Reglas"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Ubicación",
      "options": [
        { "value": "bottom_left", "label": "Abajo Izquierda" },
        { "value": "bottom_center", "label": "Abajo Centro" },
        { "value": "bottom_right", "label": "Abajo Derecha" }
      ],
      "default": "bottom_center"
    },
    {
      "type": "collection",
      "id": "target_collection",
      "label": "Colección Específica (Opcional)",
      "info": "Si se selecciona, solo aparecerá en esta colección y sus productos."
    }
  ],
  "presets": [
    {
      "name": "Teaser Popup"
    }
  ]
}
{% endschema %}
