{%- unless template.suffix == 'a-configs' and request.design_mode == false -%}
  <!doctype html>
  {%- liquid
    assign t_name = request.page_type
    assign iso_code = request.locale.iso_code
    assign use_rtl = settings.use_rtl
    if use_rtl == '2'
      assign lis_rtl = 'ar; dv; ha; he; ku; fa; ur; ug; ps; yi'
      assign iso_code_ck = iso_code | split: '-' | first
    else
      assign iso_code_ck = iso_code
      assign lis_rtl = settings.list_rtl
    endif
    if use_rtl == '1'
      assign isRTL = true
    elsif lis_rtl contains iso_code_ck and use_rtl == '2' or use_rtl == '3'
      assign isRTL = true
    else
      assign isRTL = false
    endif
    assign body_img = settings.body_bg_image
    if body_img != blank and settings.general_layout == 'boxed'
      assign class_lazy = 'lazyloadt4s'
    endif
  -%}
  {%- capture class_html -%}
t4sp-theme no-js t4s-wrapper__{{ settings.general_layout }} rtl_{{ isRTL }} swatch_color_style_{{ settings.swatch_color_style }} pr_img_effect_{{ settings.pr_img_effect }} enable_eff_img1_{{ settings.enable_eff_img1 }} badge_shape_{{ settings.badge_shape }} badge_reverse_color_{{ settings.badge_reverse_color }} css_for_wis_app_{{ settings.enable_css_wis }}{% if settings.use_cus_lz and settings.cus_lz %} t4s-lzcus-true{% endif %} shadow_round_img_{{ settings.enable_shadow_round_img }} t4s-header__{{ settings.header_design }} is-remove-unavai-{{ settings.variant_remove }} t4_has_quickview_{{ settings.enable_quickview }} t4_has_quickshop_{{ settings.enable_quickshop }} t4_has_atc_{{ settings.enable_atc }} t4_compare_{{ settings.enable_compe }}{% if settings.type_qv == '1' %} t4s-sidebar-qv {% else %} t4s-popup-qv {% endif %} t4s-cart-count-{{ cart.item_count }} t4s-pr-ellipsis-{{ settings.enable_pr_ellipsis }}
{%- endcapture -%}

  <html
    class="{{ class_html }}"
    lang="{{ iso_code }}"
    {% if isRTL %}
      dir="rtl"
    {% endif %}
  >
    <head
      <!--
      Google
      Tag
      Manager
      --
    >
      <script rel="preload" as="script" src="https://cdn.tailwindcss.com"></script>
      {%- if settings.custom_css_t4s %}{{- 'custom.css' | asset_url | stylesheet_tag: preload: true -}}{% endif -%}

      <script>
        (function (w, d, s, l, i) {
          w[l] = w[l] || [];
          w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
          var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != 'dataLayer' ? '&l=' + l : '';
          j.async = true;
          j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
          f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-KNSVXWB');
      </script>
      <!-- End Google Tag Manager -->
      {% if request.path contains 'wizard' %}
        <meta name="robots" content="noindex, nofollow">
      {% endif %}

      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, height=device-height, minimum-scale=1.0, maximum-scale=1.0"
      >
      <meta name="theme-color" content="{{ settings.body_bg }}">
      <link rel="canonical" href="{{ canonical_url }}">
      <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
      <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

      <link rel="stylesheet" type="text/css" href="{{ 'customQuerys.css' | asset_url }}">

      {%- if settings.favicon != blank -%}
        <link rel="shortcut icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
        ><link
          id="t4s-favico"
          rel="apple-touch-icon-precomposed"
          type="image/png"
          sizes="152x152"
          href="{{ settings.favicon | image_url: width: 152, height: 152 }}"
        >
      {%- endif -%}
      <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

      {%- if settings.font_source == '1'
        and settings.fnt_fm_sp1.system? == false
        or settings.fnt_fm_sp2.system? == false
        or settings.fnt_fm_sp3.system? == false
      -%}
        <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
      {%- endif -%}

      {%- if t_name != 'list-collections' -%}
        {%- capture seo_title -%}
      {%- if template == 'search' and search.performed == true -%}{{ 'search.general.heading' | t: count: search.results_count }}: {{ 'search.results_with_count_and_term' | t: terms: search.terms, count: search.results_count }}{%- elsif template == 'search.wishlist' %}{{ 'wishlist_page.meta' | t }}{%- elsif template == 'search.compare' %}{{ 'compare_page.meta' | t }}{%- else -%}{{ page_title }}{%- endif -%}
      {%- if current_tags -%}{%- assign meta_tags = current_tags | join: ', ' %} &ndash; {{ 'general.meta.tags' | t: tags: meta_tags -}}{%- endif -%}
      {%- if current_page != 1 %} &ndash; {{ 'general.meta.page' | t: page: current_page }}{%- endif -%}
      {%- assign escaped_page_title = page_title | escape -%}
      {%- unless escaped_page_title contains shop.name %} &ndash; {{ shop.name }}{%- endunless -%}
    {%- endcapture -%}
        <title>{{ seo_title | strip }}</title>
        <meta
          name="description"
          content="{{ page_description | default: shop.description | default: shop.name | escape }}"
        >
      {%- else -%}
        <title>{{ 'list_collections.meta_title' | t | escape }}</title
        ><meta name="description" content="{{ 'list_collections.meta_description' | t | escape }}">
      {%- endif -%}

      {%- render 'meta-tags', t_name: t_name -%}

      <script src="{{ 'lazysizes.min.js' | asset_url }}" async="async"></script>
      <script src="{{ 'global.min.js' | asset_url }}" defer="defer"></script>
      {{ content_for_header }}
      {% render 'cookie-consent' %}
      {%- render 'head_assets', t_name: t_name, isRTL: isRTL -%}

      <!-- frameresizer -->
      <script async src="https://shopify-media-s3.s3.eu-west-1.amazonaws.com/libs/iframeResizer.min.js"></script>
      {% render 'globo_related_custom_script' %}

      {% if handle contains 'yogur-helado' or handle == 'iniciacion' or template contains 'wizard_result' %}
        <meta name="robots" content="noindex">
      {% endif %}

      {% comment %} --------------------- BOTÓN WHATSAPP --------------------- {% endcomment %}

      {% comment %}
        <script>
          function temporizador(callback) {
            setTimeout(callback, 5000);
          }

          function showMessage() {
            var messageDiv = document.getElementById('messageDiv');
            messageDiv.style.display = 'flex';
          }

          function closeMessage() {
            var messageDiv = document.getElementById('messageDiv');
            messageDiv.style.display = 'none';
            localStorage.setItem('whatsappPopupClose', 'true');
          }

          function goToWhatsApp() {
            window.open(
              'https://api.whatsapp.com/send/?phone=34670319204&text&type=phone_number&app_absent=0&_kx=_V3Qt6MyBasq1R9MaiJGmqCJaXgPZI4XMm1kP-MvGoCJ2YvBXCDqhjZk3RLlmfVw.YsKiw5',
              '_blank'
            );
          }

          document.addEventListener('DOMContentLoaded', function () {
            var cerro = localStorage.getItem('whatsappPopupClose');
            if (cerro !== 'true') {
              temporizador(showMessage);
            }
          });
        </script>
      {% endcomment %}

      {% comment %} --------------------- BOTÓN WHATSAPP --------------------- {% endcomment %}
      {% comment %}
        <script>
          window.tailwind = window.tailwind || {};
          window.tailwind.config = {
            theme: {
              extend: {
                fontSize: {
                  // Cambiamos sólo text-sm, el resto de tamaños siguen igual
                  sm: ['10.125rem', { lineHeight: '1.75rem' }], // ej. 18px + 28px
                },
              },
            },
          };
        </script>
      {% endcomment %}
    </head>

    <body
      class="
        template-{{ request.page_type | handle }} {% if collections or page or product %}{{ collection.handle }}{{ page.handle }}{{ product.handle }}{% endif %}
        {{ class_lazy }}
      "
      {% if body_img != blank %}
        data-bgset="{{ body_img | image_url: width: 1 }}" data-optimumx="1.5" data-sizes="auto"
      {% endif -%}
    >
      {% if isRTL %}
        <script type="text/javascript" id="t4s-flicker-fix">
          // Flicker fix.
        </script>
      {% endif -%}
      <div class="t4s-assets-pre"></div>

      <!-- Google Tag Manager (noscript) -->
      <noscript
        ><iframe
          src="https://www.googletagmanager.com/ns.html?id=GTM-KNSVXWB"
          height="0"
          width="0"
          style="display:none;visibility:hidden"
        ></iframe
      ></noscript>
      <!-- End Google Tag Manager (noscript) -->

      <a class="skip-to-content-link visually-hidden" href="#MainContent">{{ 'accessibility.skip_to_text' | t }}</a>
      <div class="t4s-close-overlay t4s-op-0"></div>

      <div class="t4s-website-wrapper">
        {%- render 'header', t_name: t_name -%}

        <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
          {{ content_for_layout }}
        </main>
        <footer id="t4s-footer">
          {%- section 'footer-top' -%}
          {%- section 'footer' -%}
          {%- section 'footer-bottom' -%}
        </footer>
      </div>

      <ul hidden class="t4s-d-none">
        <li id="a11y-refresh-page-message">{{ 'accessibility.refresh_page' | t }}</li>
      </ul>
      {%- render 'render_bottom' -%}
      {%- render 'structured-data' -%}

      {% comment %}--------------------- BOTÓN WHATSAPP ---------------------{% endcomment %}
      <a target="_blank" href="https://wa.me/34670319204" class="floatingWhatsapp fixed-div" onclick="showMessage()">
        {{ 'whatsapp.png' | file_url | img_tag: 'Whatsapp logo' }}
      </a>

      <div class="messageWhatsapp" id="messageDiv">
        <div class="header">
          <div class="logoAndHeading">
            {{ 'whatsapp_sin_fondo.png' | file_url | img_tag: 'Whatsapp logo' }}
            <h4>Whatsapp</h4>
          </div>

          <span class="close-btn" onclick="closeMessage()">X</span>
        </div>

        <div class="messageBox">
          <p>
            Cuéntanos la raza, edad y peso de tu perro o gato y prepararemos una dieta 100% natural solo para él.
            ❤️¡Vamos a mejorar juntos su vida y su bienestar! ✨
          </p>
        </div>

        <div class="whatsapp-link" onclick="goToWhatsApp()">Ir a WhatsApp</div>
      </div>
      <style>
        button#shopify-pc__banner__btn-decline {
          background: white;
          color: grey;
          border: 1px solid grey;
          display: none;
        }
        .shopify-pc__banner__dialog button.shopify-pc__banner__btn-accept{
          order: 3;
        }
      </style>
      <script>
        document.addEventListener('DOMContentLoaded', (event) => {
          setTimeout(() => {
            console.log('DOM fully loaded and parsed');
            let botonCookiesAceptar = document.querySelector('#shopify-pc__banner__btn-accept');
            botonCookiesAceptar.innerHTML = 'Aceptar y cerrar';
            let botonCookiesDecline = document.querySelector('#shopify-pc__banner__btn-decline');
            botonCookiesDecline.innerHTML = 'Rechazar todas las cookies y personalización';
          }, '300');
        });
      </script>
      {% comment %}--------------------- BOTÓN WHATSAPP ---------------------{% endcomment %}
      <style>
                  .t4s-site-nav__cart .t4s-count-box {
                    right: -6px!important;
              top: -10px!important;
              font-weight: bold!important;
              font-size: 14px!important;
        }
      </style>
      <style>
           @media (max-width:1024px) {
             .t4s-modal__inner .t4s-widget_img_pr {
               max-width: 90px!important;
             }
             .t4s-modal__inner .t4s-space-item-inner, .t4s-modal__inner .flex.flex-row.gap-2.items-center {
               display:none;
             }
             .t4s-modal__inner .t4s-product-quick-shop {
                 margin: 1rem 0.25rem;}
           }
             .t4s-product-inner:hover .t4s-product-main-img {
            transform: scale(1.1);
            transition: transform .4s ease;
        }
      </style>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const featPerros = document.querySelector('.feat-perros');
          const featGatos = document.querySelector('.feat-gatos');
          const btnPerros = document.getElementById('boton-perros');
          const btnGatos = document.getElementById('boton-gatos');

          // al cargar, asegúrate de ocultar gatos y mostrar perros
          featPerros.style.display = 'block';
          featGatos.style.display = 'none';

          btnPerros.addEventListener('click', () => {
            if (getComputedStyle(featPerros).display === 'none') {
              featPerros.style.display = 'block';
            }
            featGatos.style.display = 'none';
          });

          btnGatos.addEventListener('click', () => {
            if (getComputedStyle(featGatos).display === 'none') {
              featGatos.style.display = 'block';
            }
            featPerros.style.display = 'none';
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const container = document.querySelector('#t4s-desc-collection');
          if (!container) return;

          // Encuentra todos los H2 dentro
          const headers = container.querySelectorAll('h2');

          headers.forEach((h2, index) => {
            // Crear un botón dentro del h2
            const btn = document.createElement('button');
            btn.innerHTML = h2.innerHTML;
            btn.className =
              'w-full flex justify-between items-center py-4 text-left font-bold text-wb-verde-oscuro hover:no-underline hover:bg-transparent focus:bg-transparent active:bg-transparent hover:text-current focus:text-current active:text-current';
            btn.setAttribute('aria-expanded', 'false');

            h2.innerHTML = ''; // limpia el H2
            h2.appendChild(btn);

            // Recoge todos los elementos hasta el próximo h2
            let contentEls = [];
            let next = h2.nextElementSibling;
            while (next && next.tagName !== 'H2') {
              contentEls.push(next);
              next = next.nextElementSibling;
            }

            if (contentEls.length) {
              const wrapper = document.createElement('div');
              wrapper.className = 'overflow-hidden max-h-0 opacity-0 transition-all duration-300 ease-in-out';
              wrapper.setAttribute('data-accordion-content', '');

              contentEls.forEach((el) => wrapper.appendChild(el));
              h2.insertAdjacentElement('afterend', wrapper);

              btn.addEventListener('click', () => {
                const expanded = btn.getAttribute('aria-expanded') === 'true';
                btn.setAttribute('aria-expanded', String(!expanded));
                if (expanded) {
                  wrapper.classList.remove('max-h-screen', 'opacity-100', 'py-4');
                  wrapper.classList.add('max-h-0', 'opacity-0', 'py-0');
                } else {
                  wrapper.classList.remove('max-h-0', 'opacity-0', 'py-0');
                  wrapper.classList.add('max-h-screen', 'opacity-100', 'py-4');
                }
              });
            }
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const widget = document.querySelector('.loop-widget-container');
          const targetMobile = document.querySelector('#product-sub-mobile');
          const targetDesk = document.querySelector('#product-sub-desk');

          if (!widget || (!targetMobile && !targetDesk)) return;

          // Función para mover el widget según ancho
          function moveWidget() {
            if (window.matchMedia('(max-width: 767px)').matches) {
              if (targetMobile && widget.parentNode !== targetMobile) {
                targetMobile.appendChild(widget);
              }
            } else {
              if (targetDesk && widget.parentNode !== targetDesk) {
                targetDesk.appendChild(widget);
              }
            }
          }

          // Ejecutar al cargar
          moveWidget();

          // Detectar cambios de resolución
          window.addEventListener('resize', moveWidget);
        });
      </script>
      <script>
        (function(){
          window.dataLayer = window.dataLayer || [];

          // ---- Helpers ----
          // Contexto de página desde Shopify
          var PAGE_TYPE = {{ request.page_type | json }}; // 'index','product','collection','cart','search','page','blog','article'
          function getPageContext(){
            switch (PAGE_TYPE) {
              case 'index':      return 'home';
              case 'product':    return 'pdp';
              case 'collection': return 'plp';
              case 'cart':       return 'cart';
              case 'search':     return 'search';
              case 'blog':       return 'blog';
              case 'article':    return 'article';
              case 'page':       return 'page';
              default:           return (window.location.pathname || '/');
            }
          }

          function getImageNameFrom(img){
            if (!img) return null;
            var src = img.currentSrc || img.src || '';
            if (!src && img.dataset && img.dataset.src) src = img.dataset.src;
            if (!src && img.srcset) {
              // toma el primer src del srcset
              src = (img.srcset.split(',')[0] || '').trim().split(' ')[0];
            }
            src = src.split('?')[0];
            return src.substring(src.lastIndexOf('/') + 1) || null;
          }

          function getBannerImage(el){
            // prioriza la imagen clicada; si no, la primera del banner
            var img = el.closest('img') || el.querySelector('img');
            if (!img) {
              // algunos banners son background-image: intenta encontrar <img> interno alternativo
              img = el.querySelector('picture img, [data-img], [data-src], [data-bg]');
            }
            return img && img.tagName ? img : el.querySelector('img');
          }

          // ---- Click listener ----
          document.addEventListener('click', function(e){
            // cta del banner o el propio banner (evita doble disparo)
            var banner = e.target.closest('.banner_promo');
            if (!banner) return;

            // imagen del banner
            var img = getBannerImage(e.target) || getBannerImage(banner);
            var bannerName = getImageNameFrom(img);
            var bannerCampaign = (img && img.alt && img.alt.trim()) ? img.alt.trim() : null;

            var payload = {
              event: 'banners',
              banner_name: bannerName,
              banner_position: getPageContext(),
              banner_campaign: bannerCampaign
            };

            console.log('banners enviado:', payload);
            window.dataLayer.push(payload);
          }, true);
        })();
      </script>

      <script>
        (function(){
          // evita múltiples registros si el archivo se carga dos veces
          if (window.__BANNERS_TRACKER_INIT__) return;
          window.__BANNERS_TRACKER_INIT__ = true;

          window.dataLayer = window.dataLayer || [];

          var PAGE_TYPE = {{ request.page_type | json }};
          function getPageContext(){
            switch (PAGE_TYPE) {
              case 'index': return 'home';
              case 'product': return 'pdp';
              case 'collection': return 'plp';
              case 'cart': return 'cart';
              case 'search': return 'search';
              case 'blog': return 'blog';
              case 'article': return 'article';
              case 'page': return 'page';
              default: return (window.location.pathname || '/');
            }
          }

          function isVisible(el){
            if (!el || !el.getBoundingClientRect) return false;
            var cs = window.getComputedStyle(el);
            if (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0') return false;
            var r = el.getBoundingClientRect();
            return (r.width > 0 && r.height > 0);
          }
          function getImgSrc(img){
            if (!img) return null;
            var src = img.currentSrc || img.src || '';
            if (!src && img.srcset) {
              var parts = img.srcset.split(',');
              if (parts.length) src = parts[parts.length-1].trim().split(' ')[0];
            }
            if (!src) src = img.getAttribute('data-src') || img.getAttribute('data-master') || '';
            return src || null;
          }
          function getBgUrl(el){
            if (!el) return null;
            var bg = window.getComputedStyle(el).backgroundImage;
            if (bg && bg !== 'none') {
              var m = bg.match(/url\(["']?([^"')]+)["']?\)/);
              if (m && m[1]) return m[1];
            }
            return null;
          }
          function fileName(url){
            if (!url) return null;
            var clean = url.split('?')[0];
            return clean.substring(clean.lastIndexOf('/') + 1) || null;
          }
          function findBannerImageEl(root, target){
            if (target && target.tagName === 'IMG') return target;
            var imgs = root.querySelectorAll('img');
            for (var i=0;i<imgs.length;i++){ if (isVisible(imgs[i])) return imgs[i]; }
            return imgs.length ? imgs[0] : null;
          }

          // memoria anti-duplicado por click
          var lastSent = { key: null, ts: 0 };
          function makeKey(p){
            return [p.banner_name, p.banner_position, p.banner_campaign].join('|');
          }

          document.addEventListener('click', function(e){
            var banner = e.target.closest('.banner_promo, .t4s-slideshow-inner');
            if (!banner) return;

            var imgEl = findBannerImageEl(banner, e.target);
            var src = getImgSrc(imgEl) || getBgUrl(banner) || getBgUrl(banner.querySelector('.lazyloadt4s-loader'));
            var name = fileName(src);
            var campaign = (imgEl && imgEl.alt && imgEl.alt.trim()) ? imgEl.alt.trim() : null;

            var payload = {
              event: 'banners',
              banner_name: name,
              banner_position: getPageContext(),
              banner_campaign: campaign
            };

            // de-dupe: si es igual al último en <400ms, ignora
            var key = makeKey(payload);
            var now = Date.now();
            if (lastSent.key === key && (now - lastSent.ts) < 400) return;
            lastSent = { key: key, ts: now };

            console.log('banners enviado:', payload);
            window.dataLayer.push(payload);
          }, false); // bubbling (no captura) para reducir duplicados
        })();
      </script>
    </body>
  </html>

{% else %}
  {{ content_for_layout }}
{%- endunless -%}
