{%- unless template.suffix == 'a-configs' and request.design_mode == false -%}
  <!doctype html>
  {%- liquid
    assign t_name = request.page_type
    assign iso_code = request.locale.iso_code
    assign use_rtl = settings.use_rtl
    if use_rtl == '2'
      assign lis_rtl = 'ar; dv; ha; he; ku; fa; ur; ug; ps; yi'
      assign iso_code_ck = iso_code | split: '-' | first
    else
      assign iso_code_ck = iso_code
      assign lis_rtl = settings.list_rtl
    endif
    if use_rtl == '1'
      assign isRTL = true
    elsif lis_rtl contains iso_code_ck and use_rtl == '2' or use_rtl == '3'
      assign isRTL = true
    else
      assign isRTL = false
    endif
    assign body_img = settings.body_bg_image
    if body_img != blank and settings.general_layout == 'boxed'
      assign class_lazy = 'lazyloadt4s'
    endif
  -%}
  {%- capture class_html -%}
t4sp-theme no-js t4s-wrapper__{{ settings.general_layout }} rtl_{{ isRTL }} swatch_color_style_{{ settings.swatch_color_style }} pr_img_effect_{{ settings.pr_img_effect }} enable_eff_img1_{{ settings.enable_eff_img1 }} badge_shape_{{ settings.badge_shape }} badge_reverse_color_{{ settings.badge_reverse_color }} css_for_wis_app_{{ settings.enable_css_wis }}{% if settings.use_cus_lz and settings.cus_lz %} t4s-lzcus-true{% endif %} shadow_round_img_{{ settings.enable_shadow_round_img }} t4s-header__{{ settings.header_design }} is-remove-unavai-{{ settings.variant_remove }} t4_has_quickview_{{ settings.enable_quickview }} t4_has_quickshop_{{ settings.enable_quickshop }} t4_has_atc_{{ settings.enable_atc }} t4_compare_{{ settings.enable_compe }}{% if settings.type_qv == '1' %} t4s-sidebar-qv {% else %} t4s-popup-qv {% endif %} t4s-cart-count-{{ cart.item_count }} t4s-pr-ellipsis-{{ settings.enable_pr_ellipsis }}
{%- endcapture -%}

  <html
    class="{{ class_html }}"
    lang="{{ iso_code }}"
    {% if isRTL %}
      dir="rtl"
    {% endif %}
  >
    <head
      <!--
      Google
      Tag
      Manager
      --
    >
      <script rel="preload" as="script" src="https://cdn.tailwindcss.com"></script>

      <script>
        (function (w, d, s, l, i) {
          w[l] = w[l] || [];
          w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
          var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != 'dataLayer' ? '&l=' + l : '';
          j.async = true;
          j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
          f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-KNSVXWB');
      </script>
      <!-- End Google Tag Manager -->
      {% if request.path contains 'wizard' %}
        <meta name="robots" content="noindex, nofollow">
      {% endif %}

      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, height=device-height, minimum-scale=1.0, maximum-scale=1.0"
      >
      <meta name="theme-color" content="{{ settings.body_bg }}">
      <link rel="canonical" href="{{ canonical_url }}">
      <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
      <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

      <link rel="stylesheet" type="text/css" href="{{ 'customQuerys.css' | asset_url }}">

      {% comment %}
        <script>
          (function () {
            var loc = window.location;

            // Solo dominio wildbalance.es (con o sin www) y solo la home
            var esDominioCorrecto = loc.hostname === 'wildbalance.es' || loc.hostname === 'www.wildbalance.es';

            var esHome = loc.pathname === '/' || loc.pathname === '';

            // Evitar bucle en la propia p√°gina de destino
            var yaEnWildDays = loc.pathname.indexOf('/pages/black-friday') === 0;

            if (esDominioCorrecto && esHome && !yaEnWildDays) {
              loc.replace('https://wildbalance.es/pages/black-friday');
            }
          })();
        </script>
      {% endcomment %}

      {%- if settings.favicon != blank -%}
        <link rel="shortcut icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
        ><link
          id="t4s-favico"
          rel="apple-touch-icon-precomposed"
          type="image/png"
          sizes="152x152"
          href="{{ settings.favicon | image_url: width: 152, height: 152 }}"
        >
      {%- endif -%}
      <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

      {%- if settings.font_source == '1'
        and settings.fnt_fm_sp1.system? == false
        or settings.fnt_fm_sp2.system? == false
        or settings.fnt_fm_sp3.system? == false
      -%}
        <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
      {%- endif -%}

      {%- if t_name != 'list-collections' -%}
        {%- capture seo_title -%}
      {%- if template == 'search' and search.performed == true -%}{{ 'search.general.heading' | t: count: search.results_count }}: {{ 'search.results_with_count_and_term' | t: terms: search.terms, count: search.results_count }}{%- elsif template == 'search.wishlist' %}{{ 'wishlist_page.meta' | t }}{%- elsif template == 'search.compare' %}{{ 'compare_page.meta' | t }}{%- else -%}{{ page_title }}{%- endif -%}
      {%- if current_tags -%}{%- assign meta_tags = current_tags | join: ', ' %} &ndash; {{ 'general.meta.tags' | t: tags: meta_tags -}}{%- endif -%}
      {%- if current_page != 1 %} &ndash; {{ 'general.meta.page' | t: page: current_page }}{%- endif -%}
      {%- assign escaped_page_title = page_title | escape -%}
      {%- unless escaped_page_title contains shop.name %} &ndash; {{ shop.name }}{%- endunless -%}
    {%- endcapture -%}
        <title>{{ seo_title | strip }}</title>
        <meta
          name="description"
          content="{{ page_description | default: shop.description | default: shop.name | escape }}"
        >
      {%- else -%}
        <title>{{ 'list_collections.meta_title' | t | escape }}</title
        ><meta name="description" content="{{ 'list_collections.meta_description' | t | escape }}">
      {%- endif -%}

      {%- render 'meta-tags', t_name: t_name -%}

      <script src="{{ 'lazysizes.min.js' | asset_url }}" async="async"></script>
      <script src="{{ 'global.min.js' | asset_url }}" defer="defer"></script>
      {{ content_for_header }}
      {% render 'cookie-consent' %}
      {%- render 'head_assets', t_name: t_name, isRTL: isRTL -%}

      <!-- frameresizer -->
      <script async src="https://shopify-media-s3.s3.eu-west-1.amazonaws.com/libs/iframeResizer.min.js"></script>
      {% render 'globo_related_custom_script' %}

      {% if handle contains 'yogur-helado' or handle == 'iniciacion' or template contains 'wizard_result' %}
        <meta name="robots" content="noindex">
      {% endif %}

<!-- --------------------- POPUP WHATS APP  --------------------- -->

<style>
  #whatsappPopup {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    max-width: 90%;
    background-color: #f5f1e6; /* beige */
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    font-family: 'Helvetica', sans-serif;
    z-index: 9999;
    flex-direction: column;
    overflow: hidden;
  }

  #whatsappPopup .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    background-color: #25D366; /* verde WhatsApp */
    border-radius: 15px 15px 0 0;
  }

  #whatsappPopup .header img {
    width: 30px;
    height: 30px;
    margin-right: 10px;
  }

  #whatsappPopup .header span {
    color: #fff;
    font-weight: bold;
    font-size: 14px;
  }

  #whatsappPopup .header .close-btn {
    cursor: pointer;
    font-weight: bold;
    color: #fff;
    font-size: 18px;
  }

  .chat-container {
    display: flex;
    flex-direction: column;
    padding: 12px;
    gap: 8px;
  }

  .chat-bubble {
    background-color: #fff;
    color: #000;
    padding: 10px 14px;
    border-radius: 12px;
    max-width: 100%;
    word-wrap: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  #whatsappPopup button {
    background-color: #25D366;
    color: #fff;
    border: none;
    padding: 10px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    margin: 10px;
    width: calc(100% - 20px);
    font-size: 14px;
    transition: background 0.3s;
  }

  #whatsappPopup button:hover {
    background-color: #128C7E;
  }
</style>

<div id="whatsappPopup">
  <div class="header">
    <div style="display:flex; align-items:center;">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
      <span>Almu, nutricionista</span>
    </div>
    <span class="close-btn" onclick="closePopup()">√ó</span>
  </div>
  <div class="chat-container">
    <div class="chat-bubble">Cu√©ntanos la raza, edad y peso de tu perro o gatito y personalizaremos su men√∫ 100% natural.</div>
    <div class="chat-bubble">¬°Vamos a mejorar su vida!üíö</div>
  </div>
  <button onclick="goToWhatsApp()">üí¨ Hablar por WhatsApp</button>
</div>

<script>
  function showPopup(force=false) {
    var closed = localStorage.getItem('whatsappPopupClosed');
    if(!closed || force){
      var popup = document.getElementById('whatsappPopup');
      if(popup) popup.style.display = 'flex';
    }
  }

  function closePopup() {
    var popup = document.getElementById('whatsappPopup');
    if(popup) popup.style.display = 'none';
    localStorage.setItem('whatsappPopupClosed','true');
  }

  function goToWhatsApp() {
    localStorage.removeItem('whatsappPopupClosed');
    window.open(
      'https://api.whatsapp.com/send/?phone=34670319204&text&type=phone_number&app_absent=0',
      '_blank'
    );
  }

  document.addEventListener('DOMContentLoaded', function () {
    setTimeout(showPopup, 10000); // 10 segundos despu√©s de cargar
  });
</script>

      {% comment %}
        <script>
          window.tailwind = window.tailwind || {};
          window.tailwind.config = {
            theme: {
              extend: {
                fontSize: {
                  // Cambiamos s√≥lo text-sm, el resto de tama√±os siguen igual
                  sm: ['10.125rem', { lineHeight: '1.75rem' }], // ej. 18px + 28px
                },
              },
            },
          };
        </script>
      {% endcomment %}

      <!-- --------------------- FIN POPUP WHATS APP  --------------------- -->

      {%- if settings.custom_css_t4s %}{{- 'custom.css' | asset_url | stylesheet_tag: preload: true -}}{% endif -%}
    </head>

    <body
      class="
        template-{{ request.page_type | handle }} {% if collections or page or product %}{{ collection.handle }}{{ page.handle }}{{ product.handle }}{% endif %}
        {{ class_lazy }}
      "
      {% if body_img != blank %}
        data-bgset="{{ body_img | image_url: width: 1 }}" data-optimumx="1.5" data-sizes="auto"
      {% endif -%}
    >
      {% if isRTL %}
        <script type="text/javascript" id="t4s-flicker-fix">
          // Flicker fix.
        </script>
      {% endif -%}
      <div class="t4s-assets-pre"></div>

      <!-- Google Tag Manager (noscript) -->
      <noscript
        ><iframe
          src="https://www.googletagmanager.com/ns.html?id=GTM-KNSVXWB"
          height="0"
          width="0"
          style="display:none;visibility:hidden"
        ></iframe
      ></noscript>
      <!-- End Google Tag Manager (noscript) -->

      <a class="skip-to-content-link visually-hidden" href="#MainContent">{{ 'accessibility.skip_to_text' | t }}</a>
      <div class="t4s-close-overlay t4s-op-0"></div>

      <div class="t4s-website-wrapper">
        {%- render 'header', t_name: t_name -%}

        <main id="MainContent" class="content-for-layout focus-none" role="main" tabindex="-1">
          {{ content_for_layout }}
        </main>
        <footer id="t4s-footer">
          {%- section 'footer-top' -%}
          {%- section 'footer' -%}
          {%- section 'footer-bottom' -%}
        </footer>
      </div>

      <ul hidden class="t4s-d-none">
        <li id="a11y-refresh-page-message">{{ 'accessibility.refresh_page' | t }}</li>
      </ul>
      {%- render 'render_bottom' -%}
      {%- render 'structured-data' -%}

      {% comment %}--------------------- BOT√ìN WHATSAPP ---------------------{% endcomment %}
      <a target="_blank" href="https://wa.me/34670319204" class="floatingWhatsapp fixed-div" onclick="showMessage()">
        {{ 'whatsapp.png' | file_url | img_tag: 'Whatsapp logo' }}
      </a>

      <div class="messageWhatsapp" id="messageDiv">
        <div class="header">
          <div class="logoAndHeading">
            {{ 'whatsapp_sin_fondo.png' | file_url | img_tag: 'Whatsapp logo' }}
            <h4>Whatsapp</h4>
          </div>

          <span class="close-btn" onclick="closeMessage()">X</span>
        </div>

        <div class="messageBox">
          <p>
            Cu√©ntanos la raza, edad y peso de tu perro o gato y prepararemos una dieta 100% natural solo para √©l.
            ‚ù§Ô∏è¬°Vamos a mejorar juntos su vida y su bienestar! ‚ú®
          </p>
        </div>

        <div class="whatsapp-link" onclick="goToWhatsApp()">Ir a WhatsApp</div>
      </div>
      <style>
        button#shopify-pc__banner__btn-decline {
          background: white;
          color: grey;
          border: 1px solid grey;
          display: none;
        }
        .shopify-pc__banner__dialog button.shopify-pc__banner__btn-accept{
          order: 3;
        }
      </style>
      <script>
        document.addEventListener('DOMContentLoaded', (event) => {
          setTimeout(() => {
            console.log('DOM fully loaded and parsed');
            let botonCookiesAceptar = document.querySelector('#shopify-pc__banner__btn-accept');
            botonCookiesAceptar.innerHTML = 'Aceptar y cerrar';
            let botonCookiesDecline = document.querySelector('#shopify-pc__banner__btn-decline');
            botonCookiesDecline.innerHTML = 'Rechazar todas las cookies y personalizaci√≥n';
          }, '300');
        });
      </script>
      {% comment %}--------------------- BOT√ìN WHATSAPP ---------------------{% endcomment %}
      <style>
                  .t4s-site-nav__cart .t4s-count-box {
                    right: -6px!important;
              top: -10px!important;
              font-weight: bold!important;
              font-size: 14px!important;
        }
      </style>
      <style>
           @media (max-width:1024px) {
             .t4s-modal__inner .t4s-widget_img_pr {
               max-width: 90px!important;
             }
             .t4s-modal__inner .t4s-space-item-inner, .t4s-modal__inner .flex.flex-row.gap-2.items-center {
               display:none;
             }
             .t4s-modal__inner .t4s-product-quick-shop {
                 margin: 1rem 0.25rem;}
           }
             .t4s-product-inner:hover .t4s-product-main-img {
            transform: scale(1.1);
            transition: transform .4s ease;
        }
      </style>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const featPerros = document.querySelector('.feat-perros');
          const featGatos = document.querySelector('.feat-gatos');
          const btnPerros = document.getElementById('boton-perros');
          const btnGatos = document.getElementById('boton-gatos');

          // al cargar, aseg√∫rate de ocultar gatos y mostrar perros
          featPerros.style.display = 'block';
          featGatos.style.display = 'none';

          btnPerros.addEventListener('click', () => {
            if (getComputedStyle(featPerros).display === 'none') {
              featPerros.style.display = 'block';
            }
            featGatos.style.display = 'none';
          });

          btnGatos.addEventListener('click', () => {
            if (getComputedStyle(featGatos).display === 'none') {
              featGatos.style.display = 'block';
            }
            featPerros.style.display = 'none';
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const container = document.querySelector('#t4s-desc-collection');
          if (!container) return;

          // Encuentra todos los H2 dentro
          const headers = container.querySelectorAll('h2');

          headers.forEach((h2, index) => {
            // Crear un bot√≥n dentro del h2
            const btn = document.createElement('button');
            btn.innerHTML = h2.innerHTML;
            btn.className =
              'w-full flex justify-between items-center py-4 text-left font-bold text-wb-verde-oscuro hover:no-underline hover:bg-transparent focus:bg-transparent active:bg-transparent hover:text-current focus:text-current active:text-current';
            btn.setAttribute('aria-expanded', 'false');

            h2.innerHTML = ''; // limpia el H2
            h2.appendChild(btn);

            // Recoge todos los elementos hasta el pr√≥ximo h2
            let contentEls = [];
            let next = h2.nextElementSibling;
            while (next && next.tagName !== 'H2') {
              contentEls.push(next);
              next = next.nextElementSibling;
            }

            if (contentEls.length) {
              const wrapper = document.createElement('div');
              wrapper.className = 'overflow-hidden max-h-0 opacity-0 transition-all duration-300 ease-in-out';
              wrapper.setAttribute('data-accordion-content', '');

              contentEls.forEach((el) => wrapper.appendChild(el));
              h2.insertAdjacentElement('afterend', wrapper);

              btn.addEventListener('click', () => {
                const expanded = btn.getAttribute('aria-expanded') === 'true';
                btn.setAttribute('aria-expanded', String(!expanded));
                if (expanded) {
                  wrapper.classList.remove('max-h-screen', 'opacity-100', 'py-4');
                  wrapper.classList.add('max-h-0', 'opacity-0', 'py-0');
                } else {
                  wrapper.classList.remove('max-h-0', 'opacity-0', 'py-0');
                  wrapper.classList.add('max-h-screen', 'opacity-100', 'py-4');
                }
              });
            }
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const widget = document.querySelector('.loop-widget-container');
          const targetMobile = document.querySelector('#product-sub-mobile');
          const targetDesk = document.querySelector('#product-sub-desk');

          if (!widget || (!targetMobile && !targetDesk)) return;

          // Funci√≥n para mover el widget seg√∫n ancho
          function moveWidget() {
            if (window.matchMedia('(max-width: 767px)').matches) {
              if (targetMobile && widget.parentNode !== targetMobile) {
                targetMobile.appendChild(widget);
              }
            } else {
              if (targetDesk && widget.parentNode !== targetDesk) {
                targetDesk.appendChild(widget);
              }
            }
          }

          // Ejecutar al cargar
          moveWidget();

          // Detectar cambios de resoluci√≥n
          window.addEventListener('resize', moveWidget);
        });
      </script>
      {% comment %} <script>
        (function(){
          window.dataLayer = window.dataLayer || [];

          // ---- Helpers ----
          // Contexto de p√°gina desde Shopify
          var PAGE_TYPE = {{ request.page_type | json }}; // 'index','product','collection','cart','search','page','blog','article'
          function getPageContext(){
            switch (PAGE_TYPE) {
              case 'index':      return 'home';
              case 'product':    return 'pdp';
              case 'collection': return 'plp';
              case 'cart':       return 'cart';
              case 'search':     return 'search';
              case 'blog':       return 'blog';
              case 'article':    return 'article';
              case 'page':       return 'page';
              default:           return (window.location.pathname || '/');
            }
          }

          function getImageNameFrom(img){
            if (!img) return null;
            var src = img.currentSrc || img.src || '';
            if (!src && img.dataset && img.dataset.src) src = img.dataset.src;
            if (!src && img.srcset) {
              // toma el primer src del srcset
              src = (img.srcset.split(',')[0] || '').trim().split(' ')[0];
            }
            src = src.split('?')[0];
            return src.substring(src.lastIndexOf('/') + 1) || null;
          }

          function getBannerImage(el){
            // prioriza la imagen clicada; si no, la primera del banner
            var img = el.closest('img') || el.querySelector('img');
            if (!img) {
              // algunos banners son background-image: intenta encontrar <img> interno alternativo
              img = el.querySelector('picture img, [data-img], [data-src], [data-bg]');
            }
            return img && img.tagName ? img : el.querySelector('img');
          }

          // ---- Click listener ----
          document.addEventListener('click', function(e){
            // cta del banner o el propio banner (evita doble disparo)
            var banner = e.target.closest('.banner_promo');
            if (!banner) return;

            // imagen del banner
            var img = getBannerImage(e.target) || getBannerImage(banner);
            var bannerName = getImageNameFrom(img);
            var bannerCampaign = (img && img.alt && img.alt.trim()) ? img.alt.trim() : null;

            var payload = {
              event: 'banners',
              banner_name: bannerName,
              banner_position: getPageContext(),
              banner_campaign: bannerCampaign
            };

            console.log('banners enviado:', payload);
            window.dataLayer.push(payload);
          }, true);
        })();
      </script>

      <script>
        (function(){
          // evita m√∫ltiples registros si el archivo se carga dos veces
          if (window.__BANNERS_TRACKER_INIT__) return;
          window.__BANNERS_TRACKER_INIT__ = true;

          window.dataLayer = window.dataLayer || [];

          var PAGE_TYPE = {{ request.page_type | json }};
          function getPageContext(){
            switch (PAGE_TYPE) {
              case 'index': return 'home';
              case 'product': return 'pdp';
              case 'collection': return 'plp';
              case 'cart': return 'cart';
              case 'search': return 'search';
              case 'blog': return 'blog';
              case 'article': return 'article';
              case 'page': return 'page';
              default: return (window.location.pathname || '/');
            }
          }

          function isVisible(el){
            if (!el || !el.getBoundingClientRect) return false;
            var cs = window.getComputedStyle(el);
            if (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0') return false;
            var r = el.getBoundingClientRect();
            return (r.width > 0 && r.height > 0);
          }
          function getImgSrc(img){
            if (!img) return null;
            var src = img.currentSrc || img.src || '';
            if (!src && img.srcset) {
              var parts = img.srcset.split(',');
              if (parts.length) src = parts[parts.length-1].trim().split(' ')[0];
            }
            if (!src) src = img.getAttribute('data-src') || img.getAttribute('data-master') || '';
            return src || null;
          }
          function getBgUrl(el){
            if (!el) return null;
            var bg = window.getComputedStyle(el).backgroundImage;
            if (bg && bg !== 'none') {
              var m = bg.match(/url\(["']?([^"')]+)["']?\)/);
              if (m && m[1]) return m[1];
            }
            return null;
          }
          function fileName(url){
            if (!url) return null;
            var clean = url.split('?')[0];
            return clean.substring(clean.lastIndexOf('/') + 1) || null;
          }
          function findBannerImageEl(root, target){
            if (target && target.tagName === 'IMG') return target;
            var imgs = root.querySelectorAll('img');
            for (var i=0;i<imgs.length;i++){ if (isVisible(imgs[i])) return imgs[i]; }
            return imgs.length ? imgs[0] : null;
          }

          // memoria anti-duplicado por click
          var lastSent = { key: null, ts: 0 };
          function makeKey(p){
            return [p.banner_name, p.banner_position, p.banner_campaign].join('|');
          }

          document.addEventListener('click', function(e){
            var banner = e.target.closest('.banner_promo, .t4s-slideshow-inner');
            if (!banner) return;

            var imgEl = findBannerImageEl(banner, e.target);
            var src = getImgSrc(imgEl) || getBgUrl(banner) || getBgUrl(banner.querySelector('.lazyloadt4s-loader'));
            var name = fileName(src);
            var campaign = (imgEl && imgEl.alt && imgEl.alt.trim()) ? imgEl.alt.trim() : null;

            var payload = {
              event: 'banners',
              banner_name: name,
              banner_position: getPageContext(),
              banner_campaign: campaign
            };

            // de-dupe: si es igual al √∫ltimo en <400ms, ignora
            var key = makeKey(payload);
            var now = Date.now();
            if (lastSent.key === key && (now - lastSent.ts) < 400) return;
            lastSent = { key: key, ts: now };

            console.log('banners enviado:', payload);
            window.dataLayer.push(payload);
          }, false); // bubbling (no captura) para reducir duplicados
        })();
      </script> {% endcomment %}
      <script>
  (function(){
    // Evita duplicados
    if (window.__BANNERS_TRACKER_INIT__) return;
    window.__BANNERS_TRACKER_INIT__ = true;
    window.dataLayer = window.dataLayer || [];

    var PAGE_TYPE = {{ request.page_type | json }};
    function getPageContext(){
      switch (PAGE_TYPE) {
        case 'index': return 'home';
        case 'product': return 'pdp';
        case 'collection': return 'plp';
        case 'cart': return 'cart';
        case 'search': return 'search';
        case 'blog': return 'blog';
        default: return (window.location.pathname || '/');
      }
    }

    function isVisible(el){
      if (!el || !el.getBoundingClientRect) return false;
      var cs = window.getComputedStyle(el);
      return (cs.display !== 'none' && cs.visibility !== 'hidden' && cs.opacity !== '0' && el.getBoundingClientRect().height > 0);
    }

    // Busca la imagen correcta (incluyendo hermanas si el link es un overlay vac√≠o)
    function findRelevantImage(link, container) {
      // 1. Si el link contiene una imagen visible directamente (Casos 3 y 4)
      var directImg = link.querySelector('img');
      if (directImg && isVisible(directImg)) return directImg;

      // 2. Si es un slider (Caso 1), la imagen suele ser hermana del link
      if (container) {
        var siblingImgs = container.querySelectorAll('img');
        for (var i=0; i<siblingImgs.length; i++) {
          if (isVisible(siblingImgs[i])) return siblingImgs[i];
        }
      }
      return null;
    }

    function getFilename(src){
      if (!src) return null;
      var clean = src.split('?')[0];
      return clean.substring(clean.lastIndexOf('/') + 1);
    }

    var lastSentKey = null;

    document.addEventListener('click', function(e){
      var target = e.target;
      var link = target.closest('a');

      // 1. Si no hay link, abortar inmediatamente.
      if (!link) return;

      // 2. ANTI-FALSOS POSITIVOS: Si est√° dentro de una tarjeta de producto, abortar.
      // Esto evita que fotos de producto en colecciones se detecten como banners.
      if (link.closest('.t4s-product, .t4s-product-item, .product-grid-item, .t4s-pr-grid')) return;

      var matchType = null;
      var container = null;

      // ---------------------------------------------------------
      // PATR√ìN 1: Slider The4 (Tu ejemplo 1)
      // Detecta link con clase "t4s-full-width-link" dentro de "t4s-slideshow-inner"
      // ---------------------------------------------------------
      if (link.classList.contains('t4s-full-width-link') && link.closest('.t4s-slideshow-inner')) {
        matchType = 'slider';
        container = link.closest('.t4s-slideshow-inner');
      }

      // ---------------------------------------------------------
      // PATR√ìN 2: Secci√≥n Migraciones (Tu ejemplo 2)
      // Detecta si el link est√° dentro de una secci√≥n con ID que contenga "migraciones_image"
      // ---------------------------------------------------------
      else if (link.closest('[id*="migraciones_image"]')) {
        matchType = 'migraciones';
        container = link; // En este caso el link contiene la imagen
      }

      // ---------------------------------------------------------
      // PATR√ìN 3: Banner Promo Expl√≠cito (Tus ejemplos 3 y 4)
      // Detecta si la imagen clickada o contenida tiene la clase "banner_promo"
      // ---------------------------------------------------------
      else if (target.classList.contains('banner_promo') || link.querySelector('.banner_promo')) {
        matchType = 'promo_class';
        container = link;
      }

      // SI NO ES NINGUNO DE LOS 3, NO HACEMOS NADA
      if (!matchType) return;


      // 3. Extracci√≥n de datos
      var imgEl = findRelevantImage(link, container);
      
      // Si a pesar de coincidir el patr√≥n no encontramos imagen v√°lida, abortar
      if (!imgEl) return;

      var src = imgEl.currentSrc || imgEl.src || imgEl.getAttribute('data-src');
      var filename = getFilename(src);
      var campaign = imgEl.alt || 'promo';

      // Validaci√≥n final de sanidad
      if (!filename) return;

      // 4. Env√≠o al DataLayer
      var payload = {
        event: 'banners',
        banner_name: filename,
        banner_position: getPageContext(),
        banner_campaign: campaign
      };

      // Evitar rebote (double click r√°pido)
      var key = filename + '|' + Date.now();
      // Simple debounce de 500ms basado en nombre de archivo
      if (lastSentKey === filename) return; 
      
      lastSentKey = filename;
      setTimeout(function(){ lastSentKey = null }, 1000);

      console.log('‚úÖ Banner Detectado (' + matchType + '):', payload);
      window.dataLayer.push(payload);

    }, true);
  })();
</script>


      {%- if settings.custom_css_t4s %}{{- 'custom.css' | asset_url | stylesheet_tag: preload: true -}}{% endif -%}
      <script>
        (function () {
          if (window.__klaviyoFormsHooked) return;
          window.__klaviyoFormsHooked = true;

          window.dataLayer = window.dataLayer || [];

          const leadTypeByForm = {};
          const sentCache = new Set();

          window.addEventListener('klaviyoForms', function (e) {
            const d = e && e.detail;
            if (!d) return;

            const { type, formId } = d;

            if (['open', 'flyoutOpen', 'modalOpen'].includes(type)) leadTypeByForm[formId] = 'popup';
            if (type === 'embedOpen') leadTypeByForm[formId] = 'embed';

            if (type !== 'submit') return; // solo env√≠o final

            // ---- capturamos inputs ----
            let inputsData = {};
            try {
              const formEl = document.querySelector(`[data-testid="klaviyo-form-${formId}"]`);
              if (formEl) {
                formEl.querySelectorAll('input, select, textarea').forEach((el) => {
                  const name = el.name || el.id || el.getAttribute('aria-label');
                  if (!name) return;
                  if (el.type === 'radio') {
                    if (el.checked) inputsData[name] = el.getAttribute('aria-label') || el.value || 'checked';
                  } else if (el.type === 'checkbox') {
                    inputsData[name] = el.checked;
                  } else {
                    const value = (el.value || '').trim();
                    if (value) inputsData[name] = value;
                  }
                });
              }
            } catch (err) {
              console.warn('No se pudieron leer los inputs de Klaviyo:', err);
            }

            // ---- dedupe b√°sico ----
            const email = inputsData.email || inputsData.Email || '';
            const dedupeKey = formId + '|' + email;
            if (sentCache.has(dedupeKey)) return;
            sentCache.add(dedupeKey);
            setTimeout(() => sentCache.delete(dedupeKey), 5000);

            const payloadBase = {
              event: 'klaviyo_form_submit',
              form_id: formId || null,
              form_name:
                d.formName ||
                d.formTitle ||
                (d.metaData && (d.metaData.form_name || d.metaData.formTitle)) ||
                'Klaviyo Form ' + (formId || ''),
              step: 'success',
              form_type: d.source || leadTypeByForm[formId] || 'popup',
              form_inputs: inputsData,
            };

            // ---- Si hay email, hasheamos SHA-256 ----
            if (email) {
              const normalized = email.trim().toLowerCase();
              crypto.subtle
                .digest('SHA-256', new TextEncoder().encode(normalized))
                .then((hashBuffer) => {
                  const hashArray = Array.from(new Uint8Array(hashBuffer));
                  const hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');

                  payloadBase.hashed_email = hashHex;

                  window.dataLayer.push(payloadBase);
                  console.info('‚úÖ Enviado lead Klaviyo con hash:', payloadBase);
                })
                .catch((err) => {
                  console.warn('Error generando hash:', err);
                  window.dataLayer.push(payloadBase); // fallback
                });
            } else {
              window.dataLayer.push(payloadBase);
              console.info('‚úÖ Enviado lead Klaviyo (sin email):', payloadBase);
            }
          });
        })();
      </script>
      {% render 'analytics-events' %}

      <script src="https://a.klaviyo.com/media/js/onsite/onsite.js"></script>
      <script>
        var klaviyo = klaviyo || [];
        klaviyo.init({
          account: 'YsKiw5',
          platform: 'shopify',
        });
        klaviyo.enable('backinstock', {
          trigger: {
            product_page_text: 'Av√≠same cuando est√© disponible',
            product_page_class:
              '[@media(min-width:1024px)]:!ml-4 t4s-btn-color-primary h-[43.94px] py-0 px-8 bg-[#ffcd00] text-[#004623]  rounded-full font-[700] !w-full add-to-cart-pdp klaviyo-bis-trigger flex items-center justify-center',
            product_page_text_align: 'center',
            product_page_margin: '0px',
            replace_anchor: true,
          },
          modal: {
            headline: '{product_name}',
            body_content: 'Reg√≠strate para recibir una notificaci√≥n cuando este art√≠culo vuelva a estar disponible.',
            email_field_label: 'Correo electr√≥nico',
            button_label: 'Av√≠same cuando est√© disponible',
            subscription_success_label: '¬°Listo! Te avisaremos cuando vuelva a estar disponible.',
            footer_content: '',
            additional_styles: "@import url('https://fonts.googleapis.com/css?family=Helvetica+Neue');",
            drop_background_color: '#000',
            background_color: '#fff',
            text_color: '#222',
            button_text_color: '#004623',
            button_background_color: '#ffcd00',
            close_button_color: '#ccc',
            error_background_color: '#fcd6d7',
            error_text_color: '#C72E2F',
            success_background_color: '#d3efcd',
            success_text_color: '#1B9500',
          },
        });
      </script>
    </body>
  </html>

{% else %}
  {{ content_for_layout }}
{%- endunless -%}
