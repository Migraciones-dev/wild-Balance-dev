{%- comment -%}
  Snippet: discount-product-card.liquid
  Uso: {% render 'discount-product-card', product: product, countdown_date: block.settings.countdown_date %}
{%- endcomment -%}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign isDefault = product.has_only_default_variant
  assign pid = product.id
-%}

<div class="discount-product-card bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-shadow relative">
  {%- comment -%} Cuenta atrás {%- endcomment -%}
  {% if countdown_date and countdown_date != blank %}
    <div
      class="countdown-badge absolute top-3 right-3 z-10 bg-[#F0807B] text-white px-4 py-2 rounded-full font-bold text-sm"
      data-countdown-end="{{ countdown_date }}"
    >
      00:00:00
    </div>
  {% endif %}

  {%- comment -%} Badge de descuento {%- endcomment -%}
  {% if current_variant.compare_at_price > current_variant.price %}
    {% assign discount = current_variant.compare_at_price
      | minus: current_variant.price
      | times: 100
      | divided_by: current_variant.compare_at_price
      | round
    %}
    <div class="absolute top-3 left-3 z-10 bg-[#F0807B] text-white px-3 py-1 rounded-full font-bold text-xs">
      OFERTA
    </div>
  {% endif %}

  {%- comment -%} Imagen del producto {%- endcomment -%}
  <div class="relative aspect-square bg-gray-100">
    {% if product.featured_image %}
      <a href="{{ product.url }}">
        <img
          src="{{ product.featured_image | img_url: '600x' }}"
          alt="{{ product.featured_image.alt | escape }}"
          class="w-full h-full object-cover"
          loading="lazy"
        >
      </a>
    {% else %}
      <div class="w-full h-full flex items-center justify-center text-gray-400">Sin imagen</div>
    {% endif %}
  </div>

  {%- comment -%} Información del producto {%- endcomment -%}
  <div class="p-4">
    {%- comment -%} Título {%- endcomment -%}
    <h3 class="text-sm lg:text-base font-semibold mb-2 line-clamp-2 min-h-[2.5rem]">
      <a href="{{ product.url }}" class="hover:text-[#004622]">
        {{ product.title }}
      </a>
    </h3>

    {%- comment -%} Precio {%- endcomment -%}
    <div class="flex items-center gap-2 mb-4">
      <span class="text-lg lg:text-xl font-bold text-[#004622]">
        {{ current_variant.price | money }}
      </span>
      {% if current_variant.compare_at_price > current_variant.price %}
        <span class="text-sm text-gray-400 line-through">
          {{ current_variant.compare_at_price | money }}
        </span>
      {% endif %}
    </div>

    {%- comment -%} Botón añadir al carrito {%- endcomment -%}
    {% if product.available %}
      {% if isDefault %}
        {%- comment -%} Producto sin variantes - añadir directamente {%- endcomment -%}
        <button
          class="add-to-cart-btn w-full bg-[#FFC107] hover:bg-[#FFB300] text-black font-bold py-3 px-4 rounded-full transition-colors"
          data-variant-id="{{ current_variant.id }}"
          data-product-id="{{ pid }}"
          data-product-available="true"
          data-has-variants="false"
        >
          Añadir al carrito
        </button>
      {% else %}
        {%- comment -%} Producto con variantes - abrir quick view {%- endcomment -%}
        <button
          class="add-to-cart-btn w-full bg-[#FFC107] hover:bg-[#FFB300] text-black font-bold py-3 px-4 rounded-full transition-colors"
          data-product-id="{{ pid }}"
          data-product-url="{{ product.url }}"
          data-has-variants="true"
          data-action-quickview
        >
          Añadir al carrito
        </button>
      {% endif %}
    {% else %}
      <button
        class="w-full bg-gray-300 text-gray-600 font-bold py-3 px-4 rounded-full cursor-not-allowed"
        disabled
      >
        Agotado
      </button>
    {% endif %}
  </div>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
