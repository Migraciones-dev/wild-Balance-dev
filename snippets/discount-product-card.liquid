{%- comment -%}
  Snippet: discount-product-card.liquid
  Uso: {% render 'discount-product-card', product: product, countdown_date: block.settings.countdown_date, show_discount_badge: block.settings.show_discount_badge %}
{%- endcomment -%}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign isDefault = product.has_only_default_variant
  assign pid = product.id

  assign discount_percentage = 0
  if current_variant.compare_at_price > current_variant.price
    assign discount_percentage = current_variant.compare_at_price | minus: current_variant.price | times: 100 | divided_by: current_variant.compare_at_price | round: 0
  endif
-%}

<div class="discount-product-card">
  <div class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-shadow relative">
    {%- comment -%} Badge circular solo si show_discount_badge == 'discount' {%- endcomment -%}
    {% if show_discount_badge == 'discount' and current_variant.compare_at_price > current_variant.price %}
      <div
        class="discount-circle absolute top-4 right-4 z-10 w-16 h-16 lg:w-20 lg:h-20 rounded-full flex items-center justify-center font-bold text-center flex-col"
        style="background-color: {{ countdown_bg_color | default: '#000000' }}; color: {{ countdown_text_color | default: '#ffffff' }};"
      >
        <span class="text-xl lg:text-2xl font-black">-{{ discount_percentage }}%</span>
      </div>
    {% endif %}

    {%- comment -%} Cuenta atrás si está configurada y seleccionada {%- endcomment -%}
    {% if show_discount_badge == 'countdown' and countdown_date and countdown_date != blank %}
      <div
        class="countdown-badge absolute top-3 right-3 z-20 px-4 py-2 rounded-full font-bold text-[8px] lg:text-[11px]"
        data-countdown-end="{{ countdown_date }}"
        style="background-color: {{ countdown_bg_color | default: '#F0807B' }}; color: {{ countdown_text_color | default: '#ffffff' }};"
      >
        00:00:00
      </div>
    {% endif %}

    {%- comment -%} Imagen del producto con botón dentro {%- endcomment -%}
    <div class="relative aspect-square bg-gray-100">
      {% if product.featured_image %}
        <a href="{{ product.url }}">
          <img
            src="{{ product.featured_image | img_url: '600x' }}"
            alt="{{ product.featured_image.alt | escape }}"
            class="w-full h-full object-cover"
            loading="lazy"
          >
        </a>
      {% else %}
        <div class="w-full h-full flex items-center justify-center text-gray-400">Sin imagen</div>
      {% endif %}

      {%- comment -%} Botón añadir al carrito dentro de la imagen {%- endcomment -%}
      {% if product.available %}
        {% if isDefault %}
          {%- comment -%} Producto sin variantes - botón HTML {%- endcomment -%}
          <button
            class="add-to-cart-btn absolute bottom-4 left-1/2 -translate-x-1/2 px-6 bg-[#FFC107] text-[#004622] font-bold py-2.5 rounded-full transition-colors text-[10px] lg:text-[12px] whitespace-nowrap z-20"
            data-variant-id="{{ current_variant.id }}"
            data-product-id="{{ pid }}"
            data-product-available="true"
            data-has-variants="false"
          >
            Añadir al carrito
          </button>
        {% else %}
          {%- comment -%} Producto con variantes - DEBE SER UN ENLACE <a> {%- endcomment -%}
          <a
            href="{{ product.url }}"
            data-id="{{ pid }}"
            data-action-quickview
            class="absolute bottom-4 left-1/2 -translate-x-1/2 px-6 bg-[#FFC107] text-[#004622] font-bold py-2.5 rounded-full transition-colors hover:bg-[#004622] hover:text-white text-[10px] lg:text-[12px] whitespace-nowrap z-20 inline-block text-center no-underline"
          >
            Añadir al carrito
          </a>
        {% endif %}
      {% else %}
        <button
          class="absolute bottom-4 left-1/2 -translate-x-1/2 px-6 bg-gray-300 text-gray-600 font-bold py-2.5 rounded-full cursor-not-allowed text-[10px] lg:text-[12px] whitespace-nowrap z-20"
          disabled
        >
          Agotado
        </button>
      {% endif %}
    </div>
  </div>

  {%- comment -%} Información del producto {%- endcomment -%}
  <div class="pt-3 pb-1">
    <h3 class="text-[13px] font-semibold mb-2 line-clamp-2 min-h-[2.5rem] text-white">
      <a href="{{ product.url }}" class="hover:opacity-80">
        {{ product.title }}
      </a>
    </h3>

    <div class="flex items-center gap-2">
      <span class="product-price text-[14px] font-bold">
        {{ current_variant.price | money }}
      </span>
      {% if current_variant.compare_at_price > current_variant.price %}
        <span class="product-compare-price text-[12px]">
          {{ current_variant.compare_at_price | money }}
        </span>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Countdown timers - CON FIX PARA SAFARI/iOS
    const countdownBadges = document.querySelectorAll('[data-countdown-end]');

    countdownBadges.forEach((badge) => {
      const endDateStr = badge.getAttribute('data-countdown-end');
      if (!endDateStr) return;

      // FIX PARA SAFARI/iOS: Convertir formato YYYY-MM-DD HH:MM a ISO 8601
      const parts = endDateStr.split(' ');
      const datePart = parts[0]; // YYYY-MM-DD
      const timePart = parts[1] || '00:00'; // HH:MM

      // Convertir a formato ISO 8601: YYYY-MM-DDTHH:MM:00
      const isoDate = `${datePart}T${timePart}:00`;
      const endDate = new Date(isoDate).getTime();

      if (isNaN(endDate)) {
        console.error('❌ Error al parsear la fecha. Verifica el formato: YYYY-MM-DD HH:MM');
        return;
      }

      function updateCountdown() {
        const now = new Date().getTime();
        const distance = endDate - now;

        if (distance < 0) {
          badge.textContent = '00:00:00';
          return;
        }

        const totalHours = Math.floor(distance / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        const hoursStr = totalHours.toString().padStart(2, '0');
        const minutesStr = minutes.toString().padStart(2, '0');
        const secondsStr = seconds.toString().padStart(2, '0');

        badge.textContent = `${hoursStr}:${minutesStr}:${secondsStr}`;
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);
    });
  });
</script>
