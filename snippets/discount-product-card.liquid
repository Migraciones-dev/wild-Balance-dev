{%- comment -%}
  Snippet: discount-product-card.liquid
  Uso: {% render 'discount-product-card', product: product, countdown_date: block.settings.countdown_date, show_discount_badge: block.settings.show_discount_badge %}

  Opciones para show_discount_badge:
  - 'discount': Muestra círculo con % a la derecha o etiquetas a la izquierda.
  - 'countdown': Muestra SOLO el contador a la derecha (oculta etiquetas izq).
  - 'both': Muestra AMBOS (Etiquetas Descuento Izquierda + Contador Derecha).
{%- endcomment -%}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign isDefault = product.has_only_default_variant
  assign pid = product.id

  assign discount_percentage = 0
  if current_variant.compare_at_price > current_variant.price
    assign discount_percentage = current_variant.compare_at_price | minus: current_variant.price | times: 100 | divided_by: current_variant.compare_at_price | round: 0
  endif

  assign is_countdown_active = false
  
  comment
    Solo activamos 'is_countdown_active' (que oculta las etiquetas de la izquierda)
    si la opción es ESTRICTAMENTE 'countdown'.
    Si es 'both', queremos que las etiquetas de la izquierda se sigan viendo.
  endcomment
  if show_discount_badge == 'countdown' and countdown_date and countdown_date != blank
    assign is_countdown_active = true
  endif

  comment
    Variable auxiliar para mostrar el countdown (tanto en modo 'countdown' como 'both')
  endcomment
  assign show_countdown = false
  if countdown_date and countdown_date != blank
    if show_discount_badge == 'countdown' or show_discount_badge == 'both'
      assign show_countdown = true
    endif
  endif

  assign promo_product = product
-%}

<div class="discount-product-card">
  <div class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-shadow relative">
    
    {%- comment -%} ================================================================== {%- endcomment -%}
    {%- comment -%} ETIQUETAS IZQUIERDA (Descuentos) {%- endcomment -%}
    {%- comment -%} Se muestran siempre, EXCEPTO si is_countdown_active es true {%- endcomment -%}
    {%- comment -%} ================================================================== {%- endcomment -%}

    {%- comment -%} ETIQUETA 1: "SOLO HOY 5X4" si tiene tag 'promo' {%- endcomment -%}
    {% unless is_countdown_active %}
      {%- if promo_product and promo_product.tags contains 'promo' -%}
        <div
          class="offer-tag"
          style="
            background: #f0807b;
            color: #faf5e7;
            position: absolute;
            z-index: 1;
            font-size: 1.2rem;
            border-radius: 0 0 10px 10px;
            padding: 0.5rem 0.2rem;
            left: 10%;
            font-weight: 900;
          "
        >
          <p class="offer-tag-1" style="font-size: 0.8rem; margin: 0;">-SOLO HOY-</p>
          <p class="offer-tag-2" style="font-size: 2rem; margin: -5px 0 0;">5X4</p>
        </div>
      {%- endif -%}
    {% endunless %}

    {%- comment -%} ETIQUETA 2: Descuento % automático {%- endcomment -%}
    {% unless is_countdown_active %}
      {% if current_variant.compare_at_price > current_variant.price %}
        {% unless product.tags contains 'sin-descuento' %}
          <div
            class="offer-tag"
            style="
              background: #f0807b;
              color: #faf5e7;
              position: absolute;
              z-index: 1;
              font-size: 1.2rem;
              border-radius: 0 0 10px 10px;
              padding: 0.5rem 0.2rem;
              left: 10%;
              font-weight: 900;
              z-index: 2;
            "
          >
            <p class="offer-tag-1 text-center" style="font-size: 0.8rem;">OFERTA</p>
            <p class="offer-tag-2 text-center" style="font-size: 2rem; margin: -5px 0;">{{ discount_percentage }}%</p>
          </div>
        {% endunless %}
      {% endif %}
    {% endunless %}

    {%- comment -%} ETIQUETA 3: Tag personalizado 'oferta_TEXTO_PROMO' {%- endcomment -%}
    {% unless is_countdown_active %}
      {% assign oferta_tag = '' %}
      {% for t in product.tags %}
        {% if t contains 'oferta_' %}
          {% assign oferta_tag = t %}
          {% break %}
        {% endif %}
      {% endfor %}

      {% unless oferta_tag == '' or product.tags contains 'sin-descuento' %}
        {% assign parts = oferta_tag | split: '_' %}
        {% assign oferta_texto = parts[1] | upcase %}
        {% assign oferta_promo = parts[2] | upcase %}

        <div
          class="offer-tag"
          style="
            background: #f0807b;
            color: #fff9ed;
            position: absolute;
            z-index: 3;
            font-size: 1.2rem;
            border-radius: 0 0 10px 10px;
            padding: 0.5rem 0.2rem;
            left: 10%;
            font-weight: 900;
          "
        >
          <p class="offer-tag-1 text-center" style="font-size: 0.8rem;">{{ oferta_texto }}</p>
          <p class="offer-tag-2 text-center" style="font-size: 2rem; margin: -5px 0;">{{ oferta_promo }}</p>
        </div>
      {% endunless %}
    {% endunless %}


    {%- comment -%} ================================================================== {%- endcomment -%}
    {%- comment -%} ELEMENTOS DERECHA (Badge Circular o Countdown) {%- endcomment -%}
    {%- comment -%} ================================================================== {%- endcomment -%}

    {%- comment -%} Badge circular solo si show_discount_badge == 'discount' {%- endcomment -%}
    {% if show_discount_badge == 'discount' and current_variant.compare_at_price > current_variant.price %}
      <div
        class="discount-circle absolute top-4 right-4 z-10 w-16 h-16 lg:w-20 lg:h-20 rounded-full flex items-center justify-center font-bold text-center flex-col"
        style="background-color: {{ countdown_bg_color | default: '#000000' }}; color: {{ countdown_text_color | default: '#ffffff' }};"
      >
        <span class="text-xl lg:text-2xl font-black">-{{ discount_percentage }}%</span>
      </div>
    {% endif %}

    {%- comment -%} 
      Cuenta atrás: Se muestra si show_countdown es true.
      En el modo 'both', convivirá con las etiquetas de la izquierda.
    {%- endcomment -%}
    {% if show_countdown %}
      <div
        class="countdown-badge absolute top-3 right-3 z-20 px-4 py-2 rounded-full font-bold text-[8px] lg:text-[11px]"
        data-countdown-end="{{ countdown_date }}"
        style="background-color: {{ countdown_bg_color | default: '#F0807B' }}; color: {{ countdown_text_color | default: '#ffffff' }};"
      >
        00:00:00
      </div>
    {% endif %}


    {%- comment -%} Imagen del producto con botón dentro {%- endcomment -%}
    <div class="relative aspect-square bg-gray-100">
      {% if product.featured_image %}
        <a href="{{ product.url }}">
          <img
            src="{{ product.featured_image | img_url: '600x' }}"
            alt="{{ product.featured_image.alt | escape }}"
            class="w-full h-full object-cover"
            loading="lazy"
          >
        </a>
      {% else %}
        <div class="w-full h-full flex items-center justify-center text-gray-400">Sin imagen</div>
      {% endif %}

      {%- comment -%} Botón añadir al carrito dentro de la imagen {%- endcomment -%}
      {% if product.available %}
        {% if isDefault %}
          {%- comment -%} Producto sin variantes - botón HTML {%- endcomment -%}
          <button
            class="add-to-cart-btn absolute bottom-4 left-1/2 -translate-x-1/2 px-6 bg-[#FFC107] text-[#004622] font-bold py-2.5 rounded-full transition-colors text-[10px] lg:text-[12px] whitespace-nowrap z-20"
            data-variant-id="{{ current_variant.id }}"
            data-product-id="{{ pid }}"
            data-product-available="true"
            data-has-variants="false"
          >
            Añadir al carrito
          </button>
        {% else %}
          {%- comment -%} Producto con variantes - DEBE SER UN ENLACE <a> {%- endcomment -%}
          <a
            href="{{ product.url }}"
            data-id="{{ pid }}"
            data-action-quickview
            class="absolute bottom-4 left-1/2 -translate-x-1/2 px-6 bg-[#FFC107] text-[#004622] font-bold py-2.5 rounded-full transition-colors hover:bg-[#004622] hover:text-white text-[10px] lg:text-[12px] whitespace-nowrap z-20 inline-block text-center no-underline"
          >
            Añadir al carrito
          </a>
        {% endif %}
      {% else %}
        <button
          class="absolute bottom-4 left-1/2 -translate-x-1/2 px-6 bg-gray-300 text-gray-600 font-bold py-2.5 rounded-full cursor-not-allowed text-[10px] lg:text-[12px] whitespace-nowrap z-20"
          disabled
        >
          Agotado
        </button>
      {% endif %}
    </div>
  </div>

  {%- comment -%} Información del producto {%- endcomment -%}
  <div class="pt-3 pb-1">
    <h3 class="text-[13px] font-semibold mb-2 line-clamp-2 min-h-[2.5rem] text-white">
      <a href="{{ product.url }}" class="hover:opacity-80">
        {{ product.title }}
      </a>
    </h3>

    <div class="flex items-center gap-2">
      <span class="product-price text-[14px] font-bold">
        {{ current_variant.price | money }}
      </span>
      {% if current_variant.compare_at_price > current_variant.price %}
        <span class="product-compare-price text-[12px]">
          {{ current_variant.compare_at_price | money }}
        </span>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const countdownBadges = document.querySelectorAll('[data-countdown-end]');

    countdownBadges.forEach((badge) => {
      const endDateStr = badge.getAttribute('data-countdown-end');
      if (!endDateStr) return;

      const parts = endDateStr.split(' ');
      const datePart = parts[0];
      const timePart = parts[1] || '00:00';

      const isoDate = `${datePart}T${timePart}:00`;
      const endDate = new Date(isoDate).getTime();

      if (isNaN(endDate)) {
        console.error('❌ Error al parsear la fecha. Verifica el formato: YYYY-MM-DD HH:MM');
        return;
      }

      function updateCountdown() {
        const now = new Date().getTime();
        const distance = endDate - now;

        if (distance < 0) {
          badge.textContent = '00:00:00';
          return;
        }

        const totalHours = Math.floor(distance / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        const hoursStr = totalHours.toString().padStart(2, '0');
        const minutesStr = minutes.toString().padStart(2, '0');
        const secondsStr = seconds.toString().padStart(2, '0');

        badge.textContent = `${hoursStr}:${minutesStr}:${secondsStr}`;
      }

      updateCountdown();
      setInterval(updateCountdown, 1000);
    });
  });
</script>
