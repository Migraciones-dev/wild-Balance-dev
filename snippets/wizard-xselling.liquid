<!-- Upselling de resultados Result Page Wizard -->

{% if result.pet == 'GATO' %}
  {% assign xsellingProducts = collections['wizard-xselling-gatitos'].products %}
{% else %}
  {% assign xsellingProducts = collections['wizard-xselling-perritos'].products %}
{% endif %}

<div
  class="wizard-variant-results mt:10 lg:mt-20 !bg-[#F4F0E2] [@media(max-width:1024px)]:!flex-nowrap [@media(max-width:1024px)]:!justify-start"
  data-xselling-init="true"
>
  {% for product in xsellingProducts limit: 4 %}
    <label
      class="xselling-card"
      style="user-select:none; touch-action:manipulation; cursor:pointer;"
      data-variant-id="{{ product.variants[0].id }}"
    >
      <div class="variant-result [@media(max-width:1024px)]:!w-[80vw] !text-left !items-start">
        {{ product.featured_image | image_url: width: 300 | image_tag }}

        <h2 class="my-0 !text-[18px] lg:!text-[28px] leading-[1] !font-semibold font-[Barlow] mb-4 !mt-0 !pb-2">
          <input
            type="checkbox"
            id="xselling_{{ product.variants[0].id }}"
            name="xselling"
            value="{{ product.variants[0].id }}"
            data-xselling-input="true"
          >
          {{ product.title }}
        </h2>

        {{ product.variants[0].price | money_with_currency }}
        <br>
        <br>
        <span class="label select !self-start">Seleccionar</span>
        <span class="label selected hidden !self-start">Seleccionado</span>
      </div>
    </label>
  {% endfor %}
</div>

<script type="module">
  (function initXselling() {
    // Buscar el contenedor
    const container = document.querySelector('[data-xselling-init="true"]');

    if (!container) {
      // Si no existe, esperar a que se cree
      setTimeout(initXselling, 100);
      return;
    }

    const labels = Array.from(container.querySelectorAll('.xselling-card'));

    if (labels.length === 0) {
      setTimeout(initXselling, 100);
      return;
    }

    function updateCard(card) {
      const input = card.querySelector('[data-xselling-input="true"]');
      if (!input) return;

      const checked = input.checked;
      const variantResult = card.querySelector('.variant-result');
      const selectSpan = card.querySelector('.label.select');
      const selectedSpan = card.querySelector('.label.selected');

      if (variantResult) {
        variantResult.classList.toggle('active', checked);
      }

      if (selectSpan) {
        selectSpan.classList.toggle('hidden', checked);
      }

      if (selectedSpan) {
        selectedSpan.classList.toggle('hidden', !checked);
      }
    }

    labels.forEach((label) => {
      const input = label.querySelector('[data-xselling-input="true"]');

      if (!input) return;

      // Event listener en el label
      label.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        input.checked = !input.checked;
        updateCard(label);
      });

      // También agregar listener al input directamente por si acaso
      input.addEventListener('change', () => {
        updateCard(label);
      });

      // Estado inicial
      updateCard(label);
    });
  })();
</script>

<style>
  .wizard-variant-results {
    /* Tus estilos aquí */
  }
</style>
