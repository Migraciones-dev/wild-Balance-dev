<!-- Upselling de resultados Result Page Wizard -->

{% if result.pet == 'GATO' %}
  {% assign xsellingProducts = collections['wizard-xselling-gatitos'].products %}
{% else %}
  {% assign xsellingProducts = collections['wizard-xselling-perritos'].products %}
{% endif %}

<div
  class="wizard-variant-results mt:10 lg:mt-20 !bg-[#F4F0E2] [@media(max-width:1024px)]:!flex-nowrap [@media(max-width:1024px)]:!justify-start"
>
  {% for product in xsellingProducts limit: 4 %}
    <label
      class="xselling-card"
      style="user-select:none; touch-action:manipulation; cursor:pointer;"
      data-variant-id="{{ product.variants[0].id }}"
    >
      <div class="variant-result [@media(max-width:1024px)]:!w-[80vw] !text-left !items-start">
        {{ product.featured_image | image_url: width: 300 | image_tag }}

        <h2 class="my-0 !text-[18px] lg:!text-[28px] leading-[1] !font-semibold font-[Barlow] mb-4 !mt-0 !pb-2">
          <input
            type="checkbox"
            id="xselling_{{ product.variants[0].id }}"
            name="xselling"
            value="{{ product.variants[0].id }}"
            style="position: absolute; opacity: 0; pointer-events: none;"
          >
          {{ product.title }}
        </h2>

        {{ product.variants[0].price | money_with_currency }}
        <br>
        <br>
        <span class="label select !self-start">Seleccionar</span>
        <span class="label selected hidden !self-start">Seleccionado</span>
      </div>
    </label>
  {% endfor %}
</div>

<script>
  (function () {
    console.log('üöÄ INICIANDO WIZARD XSELLING SCRIPT');

    const container = document.querySelector('.wizard-variant-results');
    console.log('üì¶ Container encontrado:', container);

    if (!container) {
      console.error('‚ùå Container no encontrado');
      return;
    }

    const labels = container.querySelectorAll('.xselling-card');
    console.log('üè∑Ô∏è Labels encontrados:', labels.length);

    if (!labels.length) {
      console.error('‚ùå No se encontraron labels');
      return;
    }

    function refreshCard(card) {
      console.log('üîÑ Refreshing card:', card);

      const input = card.querySelector('input[name="xselling"]');
      console.log('  - Input encontrado:', input);

      if (!input) {
        console.error('  - ‚ùå Input no encontrado en esta card');
        return;
      }

      const on = input.checked;
      console.log('  - Estado del checkbox:', on ? '‚úÖ CHECKED' : '‚ùå UNCHECKED');

      const variantResult = card.querySelector('.variant-result');
      const sel = card.querySelector('.selected');
      const pick = card.querySelector('.select');

      console.log('  - variant-result:', variantResult ? '‚úì' : '‚úó');
      console.log('  - .selected:', sel ? '‚úì' : '‚úó');
      console.log('  - .select:', pick ? '‚úì' : '‚úó');

      if (variantResult) {
        variantResult.classList.toggle('active', on);
        console.log('  - Toggle "active" en variant-result:', on ? 'AGREGADO' : 'REMOVIDO');
      }

      if (sel) {
        sel.classList.toggle('hidden', !on);
        console.log('  - Toggle "hidden" en .selected:', !on ? 'AGREGADO' : 'REMOVIDO');
      }

      if (pick) {
        pick.classList.toggle('hidden', on);
        console.log('  - Toggle "hidden" en .select:', on ? 'AGREGADO' : 'REMOVIDO');
      }
    }

    labels.forEach((label, index) => {
      console.log(`\nüìå PROCESANDO LABEL ${index}`);

      const input = label.querySelector('input[name="xselling"]');
      if (!input) {
        console.error(`  - ‚ùå Input no encontrado en label ${index}`);
        return;
      }

      const variantId = label.getAttribute('data-variant-id');
      console.log(`  - Variant ID: ${variantId}`);

      // Manejar el click en el label
      label.addEventListener('click', function (e) {
        console.log(`\nüëÜ CLICK en label ${index} (Variant ID: ${variantId})`);
        console.log(`  - Estado ANTES: ${input.checked ? '‚úÖ CHECKED' : '‚ùå UNCHECKED'}`);

        e.preventDefault();
        console.log('  - preventDefault() ejecutado');

        // Toggle manual del checkbox
        input.checked = !input.checked;
        console.log(`  - Estado DESPU√âS: ${input.checked ? '‚úÖ CHECKED' : '‚ùå UNCHECKED'}`);

        // Actualizar la UI
        refreshCard(label);
      });

      // Estado inicial
      console.log(`  - Estado INICIAL: ${input.checked ? '‚úÖ CHECKED' : '‚ùå UNCHECKED'}`);
      refreshCard(label);
    });

    console.log('\n‚úÖ SCRIPT COMPLETAMENTE INICIALIZADO');
  })();
</script>

<style>
  .wizard-variant-results {
    /* Tus estilos aqu√≠ */
  }
</style>
